# Logto Ingress
#
# Routing for Logto multi-tenant architecture:
# - PORT 3001: Default tenant (user OIDC, Experience API)
# - PORT 3002: Admin tenant (Admin Console + Management API)
#
# The admin console (port 3002) issues tokens that must be validated
# by the same tenant, so /api must route to port 3002.
#
# https://docs.logto.io/concepts/core-service/configuration
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: logto
  namespace: auth
  labels:
    app.kubernetes.io/name: logto
  annotations:
    kubernetes.io/ingress.class: cilium
spec:
  tls:
    - hosts:
        - auth.home-infra.net
      secretName: wildcard-home-infra-net-tls
  rules:
    - host: auth.home-infra.net
      http:
        paths:
          # Admin Console and Management API (port 3002 - admin tenant)
          # Tokens are issued and validated by the same tenant
          - path: /console
            pathType: Prefix
            backend:
              service:
                name: logto
                port:
                  number: 3002
          # Management API on port 3001 - accepts https://default.logto.app/api audience
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: logto
                port:
                  number: 3001
          # Admin OIDC endpoints - needed for token validation
          # Management API fetches JWKS from issuer URL for signature validation
          - path: /oidc
            pathType: Prefix
            backend:
              service:
                name: logto
                port:
                  number: 3002
          # Default tenant: Experience UI (port 3001)
          - path: /
            pathType: Prefix
            backend:
              service:
                name: logto
                port:
                  number: 3001
