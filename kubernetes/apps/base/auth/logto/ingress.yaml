# Logto Ingress
#
# Single domain with path-based routing:
# - /console/* → Admin console (port 3002)
# - /api/* → Management API (port 3002), except Experience API
# - /api/experience/*, /api/interaction/* → Experience API (port 3001)
# - /.well-known/*, /oidc/* → OIDC endpoints (port 3001)
# - Everything else → Sign-in experience (port 3001)
#
# Note: When ENDPOINT and ADMIN_ENDPOINT are the same, path-based routing is required.
# See: https://github.com/logto-io/logto/issues/6755
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: logto
  namespace: auth
  labels:
    app.kubernetes.io/name: logto
  annotations:
    kubernetes.io/ingress.class: cilium
spec:
  tls:
    - hosts:
        - auth.home-infra.net
      secretName: wildcard-home-infra-net-tls
  rules:
    - host: auth.home-infra.net
      http:
        paths:
          # Admin console UI (port 3002)
          - path: /console
            pathType: Prefix
            backend:
              service:
                name: logto
                port:
                  number: 3002
          # Experience API endpoints - must be before /api catch-all (port 3001)
          - path: /api/experience
            pathType: Prefix
            backend:
              service:
                name: logto
                port:
                  number: 3001
          - path: /api/interaction
            pathType: Prefix
            backend:
              service:
                name: logto
                port:
                  number: 3001
          # Management API - all other /api/* endpoints (port 3002)
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: logto
                port:
                  number: 3002
          # OIDC discovery and endpoints (port 3001)
          - path: /.well-known
            pathType: Prefix
            backend:
              service:
                name: logto
                port:
                  number: 3001
          - path: /oidc
            pathType: Prefix
            backend:
              service:
                name: logto
                port:
                  number: 3001
          # Default: Sign-in experience UI (port 3001)
          - path: /
            pathType: Prefix
            backend:
              service:
                name: logto
                port:
                  number: 3001
