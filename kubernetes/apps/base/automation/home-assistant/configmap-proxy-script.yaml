# Home Assistant Proxy Configuration Script
#
# Injects trusted proxy configuration for reverse proxy support
# (Cilium Gateway API). Creates a packages/http.yaml file and ensures
# the main configuration.yaml loads packages.
apiVersion: v1
kind: ConfigMap
metadata:
  name: home-assistant-proxy-script
  namespace: automation
  labels:
    app.kubernetes.io/name: home-assistant
    app.kubernetes.io/component: server
    app.kubernetes.io/part-of: automation
data:
  inject-proxy-config.sh: |
    #!/bin/sh
    CONFIG_FILE="/config/configuration.yaml"
    # Create http.yaml package for proxy configuration
    mkdir -p /config/packages
    cat > /config/packages/http.yaml << 'EOF'
    # Reverse proxy configuration for Cilium Ingress
    # Auto-generated by Kubernetes init container
    http:
      use_x_forwarded_for: true
      trusted_proxies:
        - 10.0.0.0/8
    EOF
    # Ensure packages are enabled in main config
    if ! grep -q "packages:" "$CONFIG_FILE" 2>/dev/null; then
      echo "" >> "$CONFIG_FILE"
      echo "# Load additional configuration packages" >> "$CONFIG_FILE"
      echo "homeassistant:" >> "$CONFIG_FILE"
      echo "  packages: !include_dir_named packages" >> "$CONFIG_FILE"
    fi
    echo "Proxy configuration injected"
