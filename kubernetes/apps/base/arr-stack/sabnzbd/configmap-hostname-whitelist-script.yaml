# SABnzbd Hostname Whitelist Configuration Script
#
# Updates the host_whitelist setting in sabnzbd.ini to allow access
# via reverse proxy (Gateway API) and cluster-local DNS.
# Runs as an init container before the main SABnzbd container starts.
apiVersion: v1
kind: ConfigMap
metadata:
  name: sabnzbd-hostname-whitelist-script
  namespace: arr-stack
  labels:
    app.kubernetes.io/name: sabnzbd
    app.kubernetes.io/component: downloader
    app.kubernetes.io/part-of: arr-stack
data:
  fix-hostname-whitelist.sh: |
    #!/bin/sh
    CONFIG="/config/sabnzbd.ini"
    HOSTS="sabnzbd.${DOMAIN_PRIMARY}, sabnzbd.arr-stack.svc.cluster.local"
    if [ -f "$CONFIG" ]; then
      if grep -q "^host_whitelist" "$CONFIG"; then
        sed -i "s|^host_whitelist.*|host_whitelist = $HOSTS|" "$CONFIG"
      else
        sed -i "/^\[misc\]/a host_whitelist = $HOSTS" "$CONFIG"
      fi
      echo "Updated host_whitelist to: $HOSTS"
    else
      echo "Config file not found, will be created on first run"
    fi
