# LibreSpeed - Internet Speed Test
#
# Self-hosted bandwidth speed test tool.
# https://github.com/librespeed/speedtest
apiVersion: apps/v1
kind: Deployment
metadata:
  name: speedtest
  namespace: tools
  labels:
    app.kubernetes.io/name: speedtest
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: speedtest
  template:
    metadata:
      labels:
        app.kubernetes.io/name: speedtest
    spec:
      containers:
        - name: speedtest
          image: ghcr.io/librespeed/speedtest:latest
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          env:
            - name: TZ
              value: America/El_Salvador
            - name: MODE
              value: standalone
            - name: TITLE
              value: "Homelab Speed Test"
            - name: DB_TYPE
              value: sqlite
            - name: TELEMETRY
              value: "true"
            - name: ENABLE_ID_OBFUSCATION
              value: "true"
            - name: REDACT_IP_ADDRESSES
              value: "true"
            - name: DISABLE_IPINFO
              value: "false"
            - name: DISTANCE
              value: km
            # Admin password from secret
            - name: PASSWORD
              valueFrom:
                secretKeyRef:
                  name: speedtest-credentials
                  key: PASSWORD
            # GDPR contact email (required when telemetry is enabled)
            - name: EMAIL
              valueFrom:
                secretKeyRef:
                  name: speedtest-credentials
                  key: EMAIL
            # IPInfo API key (optional, for geolocation)
            - name: IPINFO_APIKEY
              valueFrom:
                secretKeyRef:
                  name: speedtest-credentials
                  key: IPINFO_APIKEY
                  optional: true
          volumeMounts:
            - name: data
              mountPath: /database
          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: speedtest-data
