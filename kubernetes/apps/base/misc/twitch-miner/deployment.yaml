# Twitch Channel Points Miner v2
#
# Automatically watches Twitch streams to collect channel points.
# https://github.com/rdavydov/Twitch-Channel-Points-Miner-v2
apiVersion: apps/v1
kind: Deployment
metadata:
  name: twitch-miner
  namespace: misc
  labels:
    app.kubernetes.io/name: twitch-miner
    app.kubernetes.io/component: server
    app.kubernetes.io/part-of: misc
spec:
  replicas: 1
  strategy:
    type: Recreate  # Single instance, avoid cookie conflicts
  selector:
    matchLabels:
      app.kubernetes.io/name: twitch-miner
  template:
    metadata:
      labels:
        app.kubernetes.io/name: twitch-miner
        app.kubernetes.io/component: server
        app.kubernetes.io/part-of: misc
    spec:
      securityContext:
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"
      containers:
        - name: twitch-miner
          image: rdavidoff/twitch-channel-points-miner-v2:2.0.4 # {"$imagepolicy": "flux-system:twitch-miner"}
          stdin: true
          tty: true
          env:
            - name: TZ
              value: America/El_Salvador
            - name: TERM
              value: xterm-256color
            - name: TWITCH_USERNAME
              valueFrom:
                secretKeyRef:
                  name: twitch-miner-credentials
                  key: TWITCH_USERNAME
            - name: TWITCH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: twitch-miner-credentials
                  key: TWITCH_PASSWORD
          resources:
            requests:
              memory: 128Mi
            limits:
              memory: 256Mi
          volumeMounts:
            - name: config
              mountPath: /usr/src/app/run.py
              subPath: run.py
              readOnly: true
            - name: data
              mountPath: /usr/src/app/cookies
              subPath: cookies
            - name: data
              mountPath: /usr/src/app/logs
              subPath: logs
      volumes:
        - name: config
          configMap:
            name: twitch-miner-config
        - name: data
          persistentVolumeClaim:
            claimName: twitch-miner-data
