# CiliumNetworkPolicy for Kubernetes API Server Access
#
# Standard Kubernetes NetworkPolicy with ipBlock doesn't work with Cilium's
# socket-level load balancing (bpf-lb-sock: true). When a pod connects to the
# K8s API ClusterIP (10.96.0.1:443), Cilium translates it to the backend
# (10.10.2.10:6443) at the socket level, before NetworkPolicy evaluation.
#
# CiliumNetworkPolicy with toEntities: kube-apiserver correctly identifies
# the API server and allows traffic regardless of the IP translation.
#
# See: https://docs.cilium.io/en/stable/security/policy/index.html

---
# Allow zitadel pods (including setup job) to access the Kubernetes API
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: auth-zitadel-kube-api-allow
  namespace: auth
spec:
  description: "Allow Zitadel setup job to access Kubernetes API for creating secrets"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: zitadel
  egress:
    - toEntities:
        - kube-apiserver
      toPorts:
        - ports:
            - port: "6443"
              protocol: TCP

---
# Allow OIDC setup/sync jobs to access the Kubernetes API
# These jobs manage OIDC secrets across namespaces and restart deployments
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: auth-oidc-setup-kube-api-allow
  namespace: auth
spec:
  description: "Allow OIDC setup jobs to access Kubernetes API for managing secrets"
  endpointSelector:
    matchExpressions:
      - key: app.kubernetes.io/name
        operator: In
        values:
          - zitadel-oidc-setup
          - zitadel-oidc-sync
  egress:
    - toEntities:
        - kube-apiserver
      toPorts:
        - ports:
            - port: "6443"
              protocol: TCP

# =============================================================================
# CiliumNetworkPolicy for OIDC Authentication (Zitadel Access)
# =============================================================================
# Apps with standard NetworkPolicy port 443 egress trigger Cilium's L7 proxy,
# which blocks TLS traffic to the Gateway with "403 Access denied".
# Adding a CiliumNetworkPolicy with toEndpoints for Zitadel on port 8080
# resolves this by establishing a direct endpoint route that prevents the
# L7 proxy from intercepting Gateway-bound OIDC traffic.

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: ai-open-webui-oidc-allow
  namespace: ai
spec:
  description: "Allow Open WebUI to access Zitadel for OIDC authentication"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: open-webui
  egress:
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: auth
            app.kubernetes.io/name: zitadel
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: media-immich-oidc-allow
  namespace: media
spec:
  description: "Allow Immich to access Zitadel for OIDC authentication"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: server
      app.kubernetes.io/instance: immich
  egress:
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: auth
            app.kubernetes.io/name: zitadel
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: management-paperless-oidc-allow
  namespace: management
spec:
  description: "Allow Paperless to access Zitadel for OIDC authentication"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: paperless-server
  egress:
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: auth
            app.kubernetes.io/name: zitadel
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: forgejo-oidc-allow
  namespace: forgejo
spec:
  description: "Allow Forgejo to access Zitadel for OIDC authentication"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: forgejo
  egress:
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: auth
            app.kubernetes.io/name: zitadel
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: monitoring-grafana-oidc-allow
  namespace: monitoring
spec:
  description: "Allow Grafana to access Zitadel for OIDC authentication"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: grafana
  egress:
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: auth
            app.kubernetes.io/name: zitadel
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: auth-oauth2-proxy-oidc-allow
  namespace: auth
spec:
  description: "Allow oauth2-proxy to access Zitadel for OIDC authentication"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: oauth2-proxy
  egress:
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: auth
            app.kubernetes.io/name: zitadel
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP
