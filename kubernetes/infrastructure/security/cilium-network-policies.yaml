# CiliumNetworkPolicy for Kubernetes API Server Access
#
# Standard Kubernetes NetworkPolicy with ipBlock doesn't work with Cilium's
# socket-level load balancing (bpf-lb-sock: true). When a pod connects to the
# K8s API ClusterIP (10.96.0.1:443), Cilium translates it to the backend
# (10.10.2.10:6443) at the socket level, before NetworkPolicy evaluation.
#
# CiliumNetworkPolicy with toEntities: kube-apiserver correctly identifies
# the API server and allows traffic regardless of the IP translation.
#
# See: https://docs.cilium.io/en/stable/security/policy/index.html

---
# Allow zitadel pods (including setup job) to access the Kubernetes API
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: auth-zitadel-kube-api-allow
  namespace: auth
spec:
  description: "Allow Zitadel setup job to access Kubernetes API for creating secrets"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: zitadel
  egress:
    - toEntities:
        - kube-apiserver
      toPorts:
        - ports:
            - port: "6443"
              protocol: TCP

---
# Allow OIDC setup/sync jobs to access the Kubernetes API
# These jobs manage OIDC secrets across namespaces and restart deployments
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: auth-oidc-setup-kube-api-allow
  namespace: auth
spec:
  description: "Allow OIDC setup jobs to access Kubernetes API for managing secrets"
  endpointSelector:
    matchExpressions:
      - key: app.kubernetes.io/name
        operator: In
        values:
          - zitadel-oidc-setup
          - zitadel-oidc-sync
  egress:
    - toEntities:
        - kube-apiserver
      toPorts:
        - ports:
            - port: "6443"
              protocol: TCP

# =============================================================================
# CiliumNetworkPolicy for OIDC Authentication (Zitadel Access)
# =============================================================================
# Apps with standard NetworkPolicy port 443 egress trigger Cilium's L7 proxy,
# which blocks TLS traffic to the Gateway with "403 Access denied".
# Adding a CiliumNetworkPolicy with toEndpoints for Zitadel on port 8080
# resolves this by establishing a direct endpoint route that prevents the
# L7 proxy from intercepting Gateway-bound OIDC traffic.

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: ai-open-webui-egress-allow
  namespace: ai
spec:
  description: "Allow Open WebUI to access Zitadel OIDC and internal services (Redis, Pipelines, Tika)"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: open-webui
      app.kubernetes.io/component: open-webui
  egress:
    # Zitadel for OIDC authentication
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: auth
            app.kubernetes.io/name: zitadel
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP
    # Redis for websocket/session management
    - toEndpoints:
        - matchLabels:
            app.kubernetes.io/component: open-webui-redis
            app.kubernetes.io/instance: open-webui
      toPorts:
        - ports:
            - port: "6379"
              protocol: TCP
    # Pipelines for extensibility
    - toEndpoints:
        - matchLabels:
            app.kubernetes.io/component: open-webui-pipelines
            app.kubernetes.io/instance: open-webui
      toPorts:
        - ports:
            - port: "9099"
              protocol: TCP
    # Tika for document processing
    - toEndpoints:
        - matchLabels:
            app.kubernetes.io/instance: open-webui
            app.kubernetes.io/name: tika
      toPorts:
        - ports:
            - port: "9998"
              protocol: TCP
    # Ollama for LLM inference
    - toEndpoints:
        - matchLabels:
            app.kubernetes.io/name: ollama
      toPorts:
        - ports:
            - port: "11434"
              protocol: TCP
    # ComfyUI for image generation
    - toEndpoints:
        - matchLabels:
            app.kubernetes.io/name: comfyui
      toPorts:
        - ports:
            - port: "80"
              protocol: TCP

---
# CNPG PostgreSQL pods need K8s API access for operator management and DNS
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: media-immich-postgres-api-allow
  namespace: media
spec:
  description: "Allow CNPG PostgreSQL to access K8s API server"
  endpointSelector:
    matchLabels:
      cnpg.io/cluster: immich-postgres
  egress:
    - toEntities:
        - kube-apiserver
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: kube-system
            k8s-app: kube-dns
      toPorts:
        - ports:
            - port: "53"
              protocol: UDP

---
# Allow Immich server to access CNPG PostgreSQL via direct endpoint route.
# Standard NetworkPolicy podSelector doesn't work reliably with Cilium's
# socket-level LB (bpf-lb-sock: true) for ClusterIP service connections.
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: media-immich-server-postgres-allow
  namespace: media
spec:
  description: "Allow Immich server to access PostgreSQL, Valkey, and ML"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: server
      app.kubernetes.io/instance: immich
  egress:
    - toEndpoints:
        - matchLabels:
            cnpg.io/cluster: immich-postgres
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP
    - toEndpoints:
        - matchLabels:
            app.kubernetes.io/name: valkey
            app.kubernetes.io/instance: immich
      toPorts:
        - ports:
            - port: "6379"
              protocol: TCP
    - toEndpoints:
        - matchLabels:
            app.kubernetes.io/name: machine-learning
            app.kubernetes.io/instance: immich
      toPorts:
        - ports:
            - port: "3003"
              protocol: TCP

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: media-immich-oidc-allow
  namespace: media
spec:
  description: "Allow Immich to access Zitadel for OIDC authentication"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: server
      app.kubernetes.io/instance: immich
  egress:
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: auth
            app.kubernetes.io/name: zitadel
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: management-paperless-oidc-allow
  namespace: management
spec:
  description: "Allow Paperless to access Zitadel for OIDC authentication"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: paperless-server
  egress:
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: auth
            app.kubernetes.io/name: zitadel
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: forgejo-oidc-allow
  namespace: forgejo
spec:
  description: "Allow Forgejo to access Zitadel for OIDC authentication"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: forgejo
  egress:
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: auth
            app.kubernetes.io/name: zitadel
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: monitoring-grafana-oidc-allow
  namespace: monitoring
spec:
  description: "Allow Grafana to access Zitadel for OIDC authentication"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: grafana
  egress:
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: auth
            app.kubernetes.io/name: zitadel
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: auth-oauth2-proxy-oidc-allow
  namespace: auth
spec:
  description: "Allow oauth2-proxy to access Zitadel for OIDC authentication"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: oauth2-proxy
  egress:
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: auth
            app.kubernetes.io/name: zitadel
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP
