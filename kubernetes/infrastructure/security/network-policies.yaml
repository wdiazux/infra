# Network Policies for Homelab Security
#
# This file implements basic network isolation for sensitive namespaces.
# These policies balance security with homelab practicality.
#
# Philosophy:
# - Default-deny egress (allow DNS only)
# - Explicit allow for required communication paths
# - Suitable for single-node, single-user homelab
#
# See: docs/reference/security-strategy.md

---
# =============================================================================
# AI Namespace - GPU Workloads (Ollama, ComfyUI, Open WebUI)
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ai-default-deny-egress
  namespace: ai
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    # Allow DNS queries
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ai-ollama-allow
  namespace: ai
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: ollama
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Open WebUI
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: open-webui
      ports:
        - protocol: TCP
          port: 11434
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 11434
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow model downloads (Ollama library)
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ai-open-webui-allow
  namespace: ai
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: open-webui
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 8080
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow connection to Ollama
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: ollama
      ports:
        - protocol: TCP
          port: 11434
    # Allow external HTTPS (HuggingFace, model downloads, OIDC endpoints)
    - ports:
        - protocol: TCP
          port: 443

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ai-comfyui-allow
  namespace: ai
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: comfyui
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 8188
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow model downloads
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443

---
# =============================================================================
# Media Namespace - Photos, Music, Video (Immich, Emby, Navidrome)
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: media-default-deny-egress
  namespace: media
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    # Allow DNS queries
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: media-immich-server-allow
  namespace: media
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: server
      app.kubernetes.io/instance: immich
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 2283
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow PostgreSQL connection (CloudNative-PG)
    - to:
        - podSelector:
            matchLabels:
              cnpg.io/cluster: immich-postgres
      ports:
        - protocol: TCP
          port: 5432
    # Allow Valkey (Redis) connection
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: valkey
              app.kubernetes.io/instance: immich
      ports:
        - protocol: TCP
          port: 6379
    # Allow ML API connection
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: machine-learning
              app.kubernetes.io/instance: immich
      ports:
        - protocol: TCP
          port: 3003
    # Allow HTTPS for OIDC authentication (auth.home-infra.net via Gateway)
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
    # Allow Zitadel for OIDC authentication (direct pod access)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: auth
          podSelector:
            matchLabels:
              app.kubernetes.io/name: zitadel
      ports:
        - protocol: TCP
          port: 8080

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: media-immich-ml-allow
  namespace: media
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: machine-learning
      app.kubernetes.io/instance: immich
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Immich server
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: server
              app.kubernetes.io/instance: immich
      ports:
        - protocol: TCP
          port: 3003
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow model downloads
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443

---
# CloudNative-PG PostgreSQL pods need K8s API access for cluster management
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: media-immich-postgres-allow
  namespace: media
spec:
  podSelector:
    matchLabels:
      cnpg.io/cluster: immich-postgres
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow PostgreSQL connections from Immich server
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: server
              app.kubernetes.io/instance: immich
      ports:
        - protocol: TCP
          port: 5432
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow K8s API server (required by CNPG operator)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: default
      ports:
        - protocol: TCP
          port: 443

---
# =============================================================================
# Management Namespace - Documents, Bills (Paperless, Wallos)
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: management-default-deny-egress
  namespace: management
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    # Allow DNS queries
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: management-paperless-allow
  namespace: management
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: paperless-server
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 8000
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: paperless-postgres
      ports:
        - protocol: TCP
          port: 5432
    # Allow Redis
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: paperless-redis
      ports:
        - protocol: TCP
          port: 6379
    # Allow Gotenberg (PDF conversion)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: paperless-gotenberg
      ports:
        - protocol: TCP
          port: 3000
    # Allow Tika (text extraction)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: paperless-tika
      ports:
        - protocol: TCP
          port: 9998
    # Allow HTTPS for OIDC authentication (auth.home-infra.net via Gateway)
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
    # Allow Zitadel for OIDC authentication (direct pod access)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: auth
          podSelector:
            matchLabels:
              app.kubernetes.io/name: zitadel
      ports:
        - protocol: TCP
          port: 8080

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: management-paperless-postgres-allow
  namespace: management
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: paperless-postgres
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow connections from paperless-server
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: paperless-server
      ports:
        - protocol: TCP
          port: 5432
  egress:
    # Allow DNS (needed for resolving hostnames)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: management-paperless-redis-allow
  namespace: management
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: paperless-redis
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow connections from paperless-server
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: paperless-server
      ports:
        - protocol: TCP
          port: 6379
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: management-paperless-gotenberg-allow
  namespace: management
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: paperless-gotenberg
  policyTypes:
    - Egress
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: management-paperless-tika-allow
  namespace: management
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: paperless-tika
  policyTypes:
    - Egress
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow HTTPS for model downloads
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443

---
# =============================================================================
# Backup Namespace - Velero, MinIO
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backup-default-deny-egress
  namespace: backup
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    # Allow DNS queries
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backup-minio-allow
  namespace: backup
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: minio
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Velero
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: velero
      ports:
        - protocol: TCP
          port: 9000
    # Allow from init-bucket job (same label app.kubernetes.io/name: minio)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: minio
      ports:
        - protocol: TCP
          port: 9000
    # Allow MinIO console access from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 9001
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow init-bucket job to connect to MinIO service
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: minio
      ports:
        - protocol: TCP
          port: 9000

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backup-velero-allow
  namespace: backup
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: velero
  policyTypes:
    - Egress
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow MinIO S3 API
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: minio
      ports:
        - protocol: TCP
          port: 9000
    # Allow Kubernetes API (backup/restore operations)
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443

---
# =============================================================================
# Forgejo Namespace - Git Server
# =============================================================================
# NOTE: No default-deny-egress for Forgejo namespace due to conflicts with
# Helm-generated NetworkPolicies from the PostgreSQL chart. The forgejo-server-allow
# and forgejo-runner-allow policies provide sufficient egress control.


apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: forgejo-server-allow
  namespace: forgejo
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: forgejo
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow HTTP from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 80
    # Allow SSH from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 2222
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: postgresql
              app.kubernetes.io/instance: forgejo-postgres
      ports:
        - protocol: TCP
          port: 5432
    # Allow outbound HTTPS for external integrations
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: forgejo-runner-allow
  namespace: forgejo
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: forgejo-runner
  policyTypes:
    - Egress
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow Forgejo server API
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: forgejo
      ports:
        - protocol: TCP
          port: 80
    # Allow Docker registry and internet (CI builds need to pull images)
    - ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 80

---
# =============================================================================
# Automation Namespace - Home Assistant, n8n
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: automation-home-assistant-allow
  namespace: automation
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: home-assistant
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 8123
  egress:
    # Allow all egress (needs device discovery, external APIs)
    - {}

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: automation-n8n-allow
  namespace: automation
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: n8n
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 5678
  egress:
    # Allow all egress (workflow automation needs external API access)
    - {}

---
# =============================================================================
# Media Namespace - Additional Services (Emby, Navidrome)
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: media-emby-allow
  namespace: media
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: emby
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 8096
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: media-navidrome-allow
  namespace: media
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: navidrome
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 4533
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow HTTPS for optional Last.fm/Gravatar integration
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443

---
# =============================================================================
# Management Namespace - Additional Services (Wallos)
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: management-wallos-allow
  namespace: management
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: wallos
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 80
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
# =============================================================================
# Monitoring Namespace - VictoriaMetrics Stack
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: monitoring-default-deny-egress
  namespace: monitoring
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    # Allow DNS queries
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: monitoring-victoriametrics-allow
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: victoriametrics
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from VMAgent (metrics push)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: vmagent
      ports:
        - protocol: TCP
          port: 8428
    # Allow from Grafana (queries)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: grafana
      ports:
        - protocol: TCP
          port: 8428
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 8428
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: monitoring-vmagent-allow
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: vmagent
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow self-scrape
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: vmagent
      ports:
        - protocol: TCP
          port: 8429
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow VictoriaMetrics (push metrics)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: victoriametrics
      ports:
        - protocol: TCP
          port: 8428
    # Allow kube-state-metrics scraping
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: kube-state-metrics
      ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 8081
    # Allow node-exporter scraping (runs with hostNetwork)
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 9100
    # Allow Kubernetes API scraping (apiserver, kubelet)
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 6443
        - protocol: TCP
          port: 10250

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: monitoring-grafana-allow
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: grafana
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 3000
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow VictoriaMetrics (data source)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: victoriametrics
      ports:
        - protocol: TCP
          port: 8428
    # Allow Zitadel for OIDC authentication (auth.home-infra.net via CoreDNS)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: auth
          podSelector:
            matchLabels:
              app.kubernetes.io/name: zitadel
      ports:
        - protocol: TCP
          port: 8080
    # Allow HTTPS for OIDC authentication (auth.home-infra.net via Gateway)
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: monitoring-kube-state-metrics-allow
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: kube-state-metrics
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from VMAgent (scraping)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: vmagent
      ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 8081
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow Kubernetes API (read cluster state)
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: monitoring-node-exporter-allow
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: node-exporter
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from VMAgent (scraping) - note: node-exporter uses hostNetwork
    - ports:
        - protocol: TCP
          port: 9100
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
# =============================================================================
# Tools Namespace - Developer Tools
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tools-default-deny-egress
  namespace: tools
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    # Allow DNS queries
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tools-it-tools-allow
  namespace: tools
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: it-tools
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 80
  egress:
    # Allow DNS only (stateless tool, no external dependencies)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tools-ntfy-allow
  namespace: tools
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: ntfy
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 80
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tools-homepage-allow
  namespace: tools
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: homepage
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 3000
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tools-copyparty-allow
  namespace: tools
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: copyparty
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 3923
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tools-attic-server-allow
  namespace: tools
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: attic
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 8080
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: attic-db
      ports:
        - protocol: TCP
          port: 5432

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tools-attic-db-allow
  namespace: tools
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: attic-db
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Attic server
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: attic
      ports:
        - protocol: TCP
          port: 5432
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tools-affine-server-allow
  namespace: tools
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: affine-server
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 3010
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: affine-postgres
      ports:
        - protocol: TCP
          port: 5432
    # Allow Redis
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: affine-redis
      ports:
        - protocol: TCP
          port: 6379

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tools-affine-postgres-allow
  namespace: tools
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: affine-postgres
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Affine server
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: affine-server
      ports:
        - protocol: TCP
          port: 5432
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tools-affine-redis-allow
  namespace: tools
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: affine-redis
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Affine server
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: affine-server
      ports:
        - protocol: TCP
          port: 6379
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
# =============================================================================
# Auth Namespace - Zitadel SSO
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: auth-default-deny-egress
  namespace: auth
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    # Allow DNS queries
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: auth-zitadel-allow
  namespace: auth
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: zitadel
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer/Ingress (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 8080
    # Allow from any namespace for internal OIDC (via CoreDNS rewrite)
    - from:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 8080
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: zitadel-postgres
      ports:
        - protocol: TCP
          port: 5432
    # Allow Redis
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: zitadel-redis
      ports:
        - protocol: TCP
          port: 6379
    # Allow SMTP for email notifications
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 587
        - protocol: TCP
          port: 465
    # Allow HTTPS for external IdP federation
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
    # Allow setup job to reach Zitadel API (same label app.kubernetes.io/name: zitadel)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: zitadel
      ports:
        - protocol: TCP
          port: 8080
    # K8s API access is handled by CiliumNetworkPolicy (auth-zitadel-kube-api-allow)
    # Standard NetworkPolicy with ipBlock/namespaceSelector doesn't work with Cilium's
    # socket-level LB (bpf-lb-sock: true) because the ClusterIP gets translated before
    # NetworkPolicy evaluation. CiliumNetworkPolicy with toEntities: kube-apiserver works.

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: auth-zitadel-postgres-allow
  namespace: auth
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: zitadel-postgres
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Zitadel
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: zitadel
      ports:
        - protocol: TCP
          port: 5432
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: auth-zitadel-redis-allow
  namespace: auth
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: zitadel-redis
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Zitadel
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: zitadel
      ports:
        - protocol: TCP
          port: 6379
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: auth-zitadel-login-allow
  namespace: auth
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: zitadel-login
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Cilium Gateway API (cilium-envoy proxy)
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              app.kubernetes.io/name: cilium-envoy
      ports:
        - protocol: TCP
          port: 3000
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 3000
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow Zitadel API
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: zitadel
      ports:
        - protocol: TCP
          port: 8080

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: auth-oidc-setup-allow
  namespace: auth
spec:
  podSelector:
    matchExpressions:
      - key: app.kubernetes.io/name
        operator: In
        values:
          - zitadel-oidc-setup
          - zitadel-oidc-sync
  policyTypes:
    - Egress
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow Zitadel API (health checks and OIDC management)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: zitadel
      ports:
        - protocol: TCP
          port: 8080
    # Allow HTTPS (APK package downloads and external OIDC endpoints)
    - ports:
        - protocol: TCP
          port: 443
    # K8s API access handled by CiliumNetworkPolicy (auth-oidc-setup-kube-api-allow)

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: auth-oauth2-proxy-allow
  namespace: auth
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: oauth2-proxy
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Cilium Envoy (forward auth)
    - ports:
        - protocol: TCP
          port: 4180
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow Zitadel for token validation (internal)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: zitadel
      ports:
        - protocol: TCP
          port: 8080
    # Allow HTTPS for OIDC discovery (auth.home-infra.net via external DNS)
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443


---
# =============================================================================
# Arr-Stack Namespace - Media Automation (Radarr, Sonarr, Prowlarr, Bazarr, SABnzbd, qBittorrent)
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: arr-stack-default-deny-egress
  namespace: arr-stack
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    # Allow DNS queries
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: arr-stack-radarr-allow
  namespace: arr-stack
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: radarr
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 7878
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow Prowlarr (indexer queries)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prowlarr
      ports:
        - protocol: TCP
          port: 9696
    # Allow SABnzbd (push NZB downloads)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: sabnzbd
      ports:
        - protocol: TCP
          port: 8080
    # Allow qBittorrent (push torrent downloads)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: qbittorrent
      ports:
        - protocol: TCP
          port: 8080
    # Allow HTTPS (indexer APIs, TMDB/IMDb metadata)
    - ports:
        - protocol: TCP
          port: 443

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: arr-stack-sonarr-allow
  namespace: arr-stack
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: sonarr
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 8989
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow Prowlarr (indexer queries)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prowlarr
      ports:
        - protocol: TCP
          port: 9696
    # Allow SABnzbd (push NZB downloads)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: sabnzbd
      ports:
        - protocol: TCP
          port: 8080
    # Allow qBittorrent (push torrent downloads)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: qbittorrent
      ports:
        - protocol: TCP
          port: 8080
    # Allow HTTPS (indexer APIs, TVDB/TMDB metadata)
    - ports:
        - protocol: TCP
          port: 443

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: arr-stack-prowlarr-allow
  namespace: arr-stack
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: prowlarr
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 9696
    # Allow from Radarr, Sonarr (indexer sync)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: radarr
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: sonarr
      ports:
        - protocol: TCP
          port: 9696
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow Radarr (push indexer results)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: radarr
      ports:
        - protocol: TCP
          port: 7878
    # Allow Sonarr (push indexer results)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: sonarr
      ports:
        - protocol: TCP
          port: 8989
    # Allow HTTPS (indexer sites, torrent trackers, NZB indexers)
    - ports:
        - protocol: TCP
          port: 443
    # Allow HTTP (some indexers use plain HTTP)
    - ports:
        - protocol: TCP
          port: 80

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: arr-stack-bazarr-allow
  namespace: arr-stack
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: bazarr
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 6767
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow Radarr (monitor movies)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: radarr
      ports:
        - protocol: TCP
          port: 7878
    # Allow Sonarr (monitor TV series)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: sonarr
      ports:
        - protocol: TCP
          port: 8989
    # Allow HTTPS (subtitle databases: OpenSubtitles, Addic7ed, etc.)
    - ports:
        - protocol: TCP
          port: 443

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: arr-stack-sabnzbd-allow
  namespace: arr-stack
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: sabnzbd
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 8080
    # Allow from Radarr, Sonarr (push NZB jobs)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: radarr
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: sonarr
      ports:
        - protocol: TCP
          port: 8080
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow HTTPS (SSL-secured usenet providers)
    - ports:
        - protocol: TCP
          port: 443
    # Allow Usenet NNTP (plaintext)
    - ports:
        - protocol: TCP
          port: 119
    # Allow Usenet NNTPS (SSL)
    - ports:
        - protocol: TCP
          port: 563

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: arr-stack-qbittorrent-allow
  namespace: arr-stack
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: qbittorrent
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer - WebUI (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 8080
    # Allow from LoadBalancer - BitTorrent protocol
    - ports:
        - protocol: TCP
          port: 6881
    # Allow from Radarr, Sonarr (push torrent jobs)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: radarr
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: sonarr
      ports:
        - protocol: TCP
          port: 8080
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow all egress (torrent peers use dynamic IPs and ports)
    # BitTorrent protocol requires unrestricted outbound connectivity
    - {}

---
# =============================================================================
# Printing Namespace - 3D Printer Monitoring (Obico)
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: printing-default-deny-egress
  namespace: printing
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    # Allow DNS queries
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: printing-obico-server-allow
  namespace: printing
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: obico-server
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from LoadBalancer (Cilium L2 - host network traffic)
    - ports:
        - protocol: TCP
          port: 3334
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow Redis (cache/sessions/celery)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: obico-redis
      ports:
        - protocol: TCP
          port: 6379
    # Allow ML API (failure detection)
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: obico-ml-api
      ports:
        - protocol: TCP
          port: 3333

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: printing-obico-redis-allow
  namespace: printing
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: obico-redis
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Obico server
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: obico-server
      ports:
        - protocol: TCP
          port: 6379
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: printing-obico-ml-api-allow
  namespace: printing
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: obico-ml-api
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from Obico server (image analysis requests)
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: obico-server
      ports:
        - protocol: TCP
          port: 3333
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
# =============================================================================
# Misc Namespace - Miscellaneous Services (Twitch Miner)
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: misc-default-deny-egress
  namespace: misc
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    # Allow DNS queries
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: misc-twitch-miner-allow
  namespace: misc
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: twitch-miner
  policyTypes:
    - Egress
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow HTTPS (Twitch API, GQL endpoints)
    - ports:
        - protocol: TCP
          port: 443

---
# =============================================================================
# CiliumNetworkPolicies for Kubernetes API Access
# =============================================================================
# Standard NetworkPolicy cannot allow traffic to the API server because:
# 1. API server runs on node (10.10.2.10:6443), not as a pod
# 2. Cilium's socket-level LB (bpf-lb-sock) rewrites before policy evaluation
# Use CiliumNetworkPolicy with toEntities: kube-apiserver instead.

apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: monitoring-kube-state-metrics-kube-api-allow
  namespace: monitoring
spec:
  description: Allow kube-state-metrics to access Kubernetes API for reading cluster state
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: kube-state-metrics
  egress:
    - toEntities:
        - kube-apiserver
      toPorts:
        - ports:
            - port: "6443"
              protocol: TCP

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: monitoring-vmagent-kube-api-allow
  namespace: monitoring
spec:
  description: Allow vmagent to access Kubernetes API for service discovery and scraping
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: vmagent
  egress:
    - toEntities:
        - kube-apiserver
      toPorts:
        - ports:
            - port: "6443"
              protocol: TCP

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: backup-velero-kube-api-allow
  namespace: backup
spec:
  description: Allow Velero to access Kubernetes API for backup/restore operations
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: velero
  egress:
    - toEntities:
        - kube-apiserver
      toPorts:
        - ports:
            - port: "6443"
              protocol: TCP

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: backup-node-agent-kube-api-allow
  namespace: backup
spec:
  description: Allow node-agent to access Kubernetes API for PV backup operations
  endpointSelector:
    matchLabels:
      name: node-agent
  egress:
    - toEntities:
        - kube-apiserver
      toPorts:
        - ports:
            - port: "6443"
              protocol: TCP
