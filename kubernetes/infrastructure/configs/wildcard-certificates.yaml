# Wildcard Certificates for Local HTTPS Access
#
# These certificates are requested from Let's Encrypt using DNS-01 challenge.
# cert-manager will automatically renew them before expiry (30 days).
#
# Architecture:
#   - ONE certificate per domain in cert-manager namespace (source of truth)
#   - Reflector automatically syncs secrets to all app namespaces
#   - This avoids hitting Let's Encrypt rate limits (5 certs/week per domain set)
#
# Reflector annotations on the secret enable automatic replication.
# When cert-manager renews the certificate, reflector syncs the update.
---
# Primary domain wildcard: *.home-infra.net
# Source certificate - reflector syncs to all app namespaces
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: wildcard-home-infra-net
  namespace: cert-manager
spec:
  secretName: wildcard-home-infra-net-tls
  secretTemplate:
    annotations:
      # Enable reflector to sync this secret
      reflector.v1.k8s.emberstack.com/reflection-allowed: "true"
      reflector.v1.k8s.emberstack.com/reflection-auto-enabled: "true"
      # Target namespaces for TLS secret distribution
      reflector.v1.k8s.emberstack.com/reflection-allowed-namespaces: "media,tools,monitoring,automation,ai,management,arr-stack,backup,forgejo,auth,flux-system,printing"
      reflector.v1.k8s.emberstack.com/reflection-auto-namespaces: "media,tools,monitoring,automation,ai,management,arr-stack,backup,forgejo,auth,flux-system,printing"
  issuerRef:
    name: letsencrypt-production
    kind: ClusterIssuer
  commonName: "*.home-infra.net"
  dnsNames:
    - "home-infra.net"
    - "*.home-infra.net"
  renewBefore: 720h
---
# Secondary domain wildcard: *.reynoza.org
# Used for external access (photos.reynoza.org via Pangolin)
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: wildcard-reynoza-org
  namespace: cert-manager
spec:
  secretName: wildcard-reynoza-org-tls
  secretTemplate:
    annotations:
      # Enable reflector to sync this secret
      reflector.v1.k8s.emberstack.com/reflection-allowed: "true"
      reflector.v1.k8s.emberstack.com/reflection-auto-enabled: "true"
      # Target namespace for reynoza.org (currently only media/Immich)
      reflector.v1.k8s.emberstack.com/reflection-allowed-namespaces: "media"
      reflector.v1.k8s.emberstack.com/reflection-auto-namespaces: "media"
  issuerRef:
    name: letsencrypt-production
    kind: ClusterIssuer
  commonName: "*.reynoza.org"
  dnsNames:
    - "reynoza.org"
    - "*.reynoza.org"
  renewBefore: 720h
