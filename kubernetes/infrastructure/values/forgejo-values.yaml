# Forgejo Helm Chart Values
#
# In-cluster Forgejo for GitOps with FluxCD
# Chart: oci://code.forgejo.org/forgejo-helm/forgejo
# Docs: https://forgejo.org/docs/latest/admin/installation/
#
# Admin credentials are injected via Terraform from SOPS secrets.
# Do NOT put passwords in this file.

# ============================================================================
# Global Settings
# ============================================================================

global:
  storageClass: "longhorn"

# ============================================================================
# Forgejo Configuration
# ============================================================================
# Note: The chart uses 'gitea' key for backward compatibility with Gitea chart

gitea:
  # Admin user is created automatically
  # Credentials injected by Terraform from SOPS
  admin:
    existingSecret: ""  # Using Terraform set values instead
    # Keep password stable - don't regenerate on upgrades
    # Valid values: keepUpdated, initialOnlyNoReset, initialOnlyRequireReset
    passwordMode: initialOnlyNoReset

  # Forgejo application config (app.ini)
  config:
    APP_NAME: "Homelab Git"

    server:
      DOMAIN: git.home-infra.net
      ROOT_URL: http://10.10.2.13/  # Overridden by Terraform var.forgejo_ip
      # LOCAL_ROOT_URL is used by git hooks to connect back to the server
      # Must be accessible from within the container
      LOCAL_ROOT_URL: http://localhost:80/
      SSH_DOMAIN: git.home-infra.net
      SSH_PORT: 22
      LFS_START_SERVER: true

    repository:
      DEFAULT_BRANCH: main
      DEFAULT_PRIVATE: false

    service:
      DISABLE_REGISTRATION: true  # Admin only creates users
      REQUIRE_SIGNIN_VIEW: false
      DEFAULT_KEEP_EMAIL_PRIVATE: true

    security:
      INSTALL_LOCK: true  # Skip installer, use admin from config

    database:
      DB_TYPE: postgres
      HOST: forgejo-postgres-postgresql.forgejo.svc.cluster.local:5432
      NAME: forgejo
      # USER and PASSWD are set via Terraform from SOPS secrets

    cache:
      ADAPTER: memory

    session:
      PROVIDER: memory

    log:
      MODE: console
      LEVEL: Info

    # Webhook settings for FluxCD notifications
    webhook:
      ALLOWED_HOST_LIST: "*"

    # Actions (Forgejo's CI/CD)
    # Docs: https://forgejo.org/docs/latest/admin/actions/
    actions:
      ENABLED: true
      DEFAULT_ACTIONS_URL: https://code.forgejo.org  # Forgejo actions registry
      LOG_RETENTION_DAYS: 90
      ARTIFACT_RETENTION_DAYS: 30

    # Storage for Actions artifacts and logs
    storage:
      STORAGE_TYPE: local

    # Cleanup schedule for expired artifacts/logs
    cron:
      cleanup_actions:
        ENABLED: true
        RUN_AT_START: false
        SCHEDULE: "@daily"

# ============================================================================
# Persistence
# ============================================================================

persistence:
  enabled: true
  size: 15Gi  # Increased from 5Gi for Actions artifacts/logs
  storageClass: "longhorn"
  accessModes:
    - ReadWriteOnce

# ============================================================================
# Service Configuration
# ============================================================================

service:
  http:
    type: LoadBalancer
    port: 80  # External port (routes to container port 3000)
    loadBalancerIP: "10.10.2.13"
    annotations: {}

  ssh:
    type: LoadBalancer
    port: 22
    loadBalancerIP: "10.10.2.14"
    annotations: {}

# ============================================================================
# Ingress (Optional - using LoadBalancer instead)
# ============================================================================

ingress:
  enabled: false
  # Enable if using ingress controller instead of LoadBalancer
  # className: ""
  # hosts:
  #   - host: git.home-infra.net
  #     paths:
  #       - path: /
  #         pathType: Prefix

# ============================================================================
# Resources (optimized for homelab)
# ============================================================================
# Official: 256MB min, 1GB recommended
# Forgejo is lightweight - can run on Raspberry Pi

resources:
  requests:
    memory: 256Mi
  limits:
    memory: 512Mi

# ============================================================================
# PostgreSQL (Disabled - using external Bitnami PostgreSQL)
# ============================================================================
# PostgreSQL is deployed separately via terraform/talos/postgresql.tf
# Database connection configured above in gitea.config.database

postgresql:
  enabled: false

postgresql-ha:
  enabled: false

# ============================================================================
# Redis (Disabled - using memory cache)
# ============================================================================

redis-cluster:
  enabled: false

# ============================================================================
# Init Container
# ============================================================================

# Ensure proper permissions on data directory
initContainers:
  resources:
    requests:
      memory: 64Mi
    limits:
      memory: 128Mi

# ============================================================================
# Notes
# ============================================================================
#
# Storage:
# - Uses Longhorn for persistent storage
# - 15Gi for Forgejo data (repos, LFS, Actions artifacts/logs)
# - PostgreSQL 2Gi deployed separately as forgejo-postgres (see postgresql.tf)
#
# Networking:
# - HTTP on port 80 via LoadBalancer (10.10.2.13)
# - SSH on port 22 via LoadBalancer (10.10.2.14)
# - Cilium L2 provides static IPs
#
# Security:
# - Registration disabled (admin creates users)
# - Install lock enabled (no web installer)
# - Admin credentials from SOPS
#
# Access:
# - Web UI: http://git.home-infra.net/
# - SSH: git@git.home-infra.net:owner/repo.git
# - HTTP: http://git.home-infra.net/owner/repo.git
#
# FluxCD Integration:
# - Forgejo is API-compatible with Gitea
# - Use: flux bootstrap gitea --hostname=git.home-infra.net ...
# - Token auto-generated by Terraform if enable_forgejo=true
#
# Actions (CI/CD):
# - Enabled with 90-day log retention, 30-day artifact retention
# - Requires Forgejo Runner deployment (see kubernetes/apps/base/forgejo/runner/)
# - Workflows stored in .forgejo/workflows/*.yaml
# - Runner registration: Settings > Actions > Runners
#
# Verification:
#   kubectl get pods -n forgejo
#   kubectl get svc -n forgejo
#   kubectl logs -n forgejo -l app.kubernetes.io/name=forgejo
