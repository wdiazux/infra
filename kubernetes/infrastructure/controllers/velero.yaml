# Velero - Kubernetes Backup and Disaster Recovery
#
# Provides backup and restore capabilities for Kubernetes resources and persistent volumes.
# Uses MinIO as S3-compatible backend and Longhorn CSI snapshots for volume data.
#
# Dependencies:
#   - MinIO (backup namespace) - S3-compatible storage backend
#   - Longhorn - CSI driver for volume snapshots
#   - Volume Snapshot CRDs - Required for CSI integration
#
# Docs: https://velero.io/docs/
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: velero
  namespace: backup
spec:
  interval: 30m
  timeout: 10m
  chart:
    spec:
      chart: velero
      version: "8.7.*"
      sourceRef:
        kind: HelmRepository
        name: vmware-tanzu
        namespace: flux-system
      interval: 12h
  install:
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    crds: CreateReplace
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    # Velero configuration for homelab with MinIO + Longhorn CSI

    # CRDs are managed externally (installed via kubectl apply)
    upgradeCRDs: false

    # Velero plugin for AWS (S3/MinIO)
    # Note: CSI plugin is built-in since Velero v1.14+
    initContainers:
      - name: velero-plugin-for-aws
        image: velero/velero-plugin-for-aws:v1.13.0
        imagePullPolicy: IfNotPresent
        volumeMounts:
          - mountPath: /target
            name: plugins

    # Fix kubectl image version
    kubectl:
      image:
        repository: bitnami/kubectl
        tag: "latest"

    # Use existing credentials secret (created separately with SOPS)
    credentials:
      useSecret: true
      existingSecret: velero-credentials

    # Backup storage location - MinIO S3-compatible endpoint
    configuration:
      backupStorageLocation:
        - name: default
          provider: aws
          bucket: velero
          default: true
          config:
            region: minio
            s3ForcePathStyle: "true"
            s3Url: http://minio.backup.svc.cluster.local:9000

      # Volume snapshot location - Longhorn CSI
      volumeSnapshotLocation:
        - name: longhorn
          provider: csi

      # Enable CSI snapshots
      features: EnableCSI

      # Move snapshot data to object storage (required for disaster recovery)
      defaultSnapshotMoveData: true

      # Default backup TTL (7 days)
      defaultBackupTTL: 168h

    # Deploy node agent for CSI snapshot data movement
    deployNodeAgent: true
    nodeAgent:
      podSecurityContext:
        runAsUser: 0
      containerSecurityContext:
        privileged: true

    # Backup schedules
    schedules:
      # Daily backup of application namespaces
      daily-apps:
        disabled: false
        schedule: "0 3 * * *"  # 3 AM daily
        useOwnerReferencesInBackup: false
        template:
          ttl: "168h"  # 7 days retention
          includedNamespaces:
            - ai
            - arr-stack
            - automation
            - forgejo
            - management
            - media
            - printing
            - tools
          snapshotMoveData: true
          storageLocation: default
          volumeSnapshotLocations:
            - longhorn

      # Weekly full backup (including infrastructure)
      weekly-full:
        disabled: false
        schedule: "0 2 * * 0"  # 2 AM Sunday
        useOwnerReferencesInBackup: false
        template:
          ttl: "672h"  # 4 weeks retention
          includedNamespaces:
            - ai
            - arr-stack
            - automation
            - backup
            - forgejo
            - management
            - media
            - monitoring
            - printing
            - tools
          snapshotMoveData: true
          storageLocation: default
          volumeSnapshotLocations:
            - longhorn

    # Resource limits for homelab
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

    # Note: Bucket creation handled by MinIO post-start or manually
    # Velero will retry connecting to backup storage location automatically
