# DNS Config Generator Design

**Date**: 2026-01-21
**Status**: Approved

## Overview

A Python script that generates configuration files for ControlD DNS and Pangolin VPN from FluxCD manifests, using `cluster-vars.yaml` as the source of truth.

## Problem

Currently, `domains.yaml` (ControlD) and `resources.yaml` (Pangolin) are maintained manually. When services are added or IPs change in Kubernetes, these files must be updated separately, leading to:
- Duplicate maintenance effort
- Configuration drift
- Inconsistencies between DNS and VPN resources

## Solution

A single script (`generate-dns-config.py`) that:
1. Reads IP assignments from `cluster-vars.yaml`
2. Scans Kubernetes manifests for service metadata
3. Generates both config files automatically

## Architecture

```
cluster-vars.yaml        kubernetes/apps/**/*.yaml
        │                          │
        └──────────┬───────────────┘
                   │
         ┌─────────▼─────────┐
         │  generate-dns-    │
         │    config.py      │
         └─────────┬─────────┘
                   │
        ┌──────────┴──────────┐
        ▼                     ▼
scripts/controld/       scripts/pangolin/
  domains.yaml            resources.yaml
```

## Service Discovery

### Source: cluster-vars.yaml

```yaml
data:
  IP_GRAFANA: "10.10.2.23"
  IP_OPENWEBUI: "10.10.2.19"
```

### Extraction Logic

1. Parse all `IP_*` variables from `cluster-vars.yaml`
2. Convert variable name to short name: `IP_GRAFANA` → `grafana`
3. Scan `kubernetes/apps/base/` for Service resources using that IP
4. Extract namespace and K8s service name from manifest

### Name Mappings

Some IP variable names don't match the desired DNS names:

| Variable | Short Name | Reason |
|----------|-----------|--------|
| `IP_OPENWEBUI` | `chat` | User-friendly name |
| `IP_HOMEASSISTANT` | `hass` | Common abbreviation |
| `IP_VICTORIAMETRICS` | `metrics` | Shorter |
| `IP_ITTOOLS` | `tools` | Shorter |
| `IP_FORGEJO_HTTP` | `git` | Service purpose |
| `IP_NAVIDROME` | `music` | Service purpose |

## Output Formats

### domains.yaml (ControlD)

```yaml
# Auto-generated by generate-dns-config.py
# Source: kubernetes/infrastructure/cluster-vars/cluster-vars.yaml
# Generated: 2026-01-21T10:30:00Z
#
# DO NOT EDIT MANUALLY - changes will be overwritten
# To customize: edit cluster-vars.yaml or the generator script

domains:
  - name: hubble
    ip: 10.10.2.11

  - name: git
    ip: 10.10.2.13
    suffixes: [home.arpa, home-infra.net]
```

### resources.yaml (Pangolin)

```yaml
# Auto-generated by generate-dns-config.py
# Source: kubernetes/infrastructure/cluster-vars/cluster-vars.yaml
# Generated: 2026-01-21T10:30:00Z
#
# DO NOT EDIT MANUALLY - changes will be overwritten
# To customize: edit cluster-vars.yaml or the generator script

resources:
  - name: hubble
    destination: hubble-ui.kube-system.svc.cluster.local

  - name: git
    destination: forgejo-http.forgejo.svc.cluster.local
```

## CLI Interface

```bash
# Preview what would be generated (no file writes)
./scripts/generate-dns-config.py --dry-run

# Generate both configs
./scripts/generate-dns-config.py

# Generate only one type
./scripts/generate-dns-config.py --controld-only
./scripts/generate-dns-config.py --pangolin-only

# Show diff from current files
./scripts/generate-dns-config.py --diff

# Verbose output (show service discovery)
./scripts/generate-dns-config.py --verbose
```

## Scope

### Included
- All Kubernetes LoadBalancer services with IPs in cluster-vars.yaml

### Excluded
- Non-K8s infrastructure (gateway, proxmox, nas, talos)
- Services without LoadBalancer IPs
- Helm-managed infrastructure services with hardcoded IPs

## Implementation Notes

- Pure Python 3.11+ with only PyYAML dependency (available in nix-shell)
- Discovers K8s service names by scanning manifests for `io.cilium/lb-ipam-ips` annotations
- Handles both `${IP_VAR}` substitution patterns
- Groups output by category (infrastructure, AI, apps, arr-stack)
- Preserves existing manual entries in a separate section (if any)

## Future Enhancements

- Watch mode for auto-regeneration on manifest changes
- Validation against live cluster state
- Support for custom aliases via annotation (`dns.home-infra.net/alias: chat`)
