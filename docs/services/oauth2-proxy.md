# oauth2-proxy

Forward authentication proxy for applications without native OIDC support.

---

## Overview

oauth2-proxy provides authentication for legacy applications that don't support OIDC natively. It integrates with Cilium's ext_authz (external authorization) to protect services at the Gateway API level.

| Property | Value |
|----------|-------|
| Namespace | `auth` |
| Chart | `oauth2-proxy/oauth2-proxy` |
| Version | `7.12.0` |
| Port | `4180` |

**Key Features:**

| Feature | Description |
|---------|-------------|
| Forward Auth | Returns 200 on success for ext_authz |
| Header Injection | Passes user info to downstream apps |
| Cookie Sessions | Secure cookie-based session management |
| Auto Credentials | OIDC credentials managed by CronJob |

---

## Architecture

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  User Request   │────▶│  Gateway API    │────▶│  oauth2-proxy   │
│                 │     │  (ext_authz)    │     │  (auth check)   │
└─────────────────┘     └────────┬────────┘     └────────┬────────┘
                                 │                       │
                                 │◀──────────────────────┘
                                 │  200 OK + Headers
                                 ▼
                        ┌─────────────────┐
                        │  Backend App    │
                        │  (receives      │
                        │  X-Auth-* hdrs) │
                        └─────────────────┘
```

---

## Configuration

### OIDC Provider

| Setting | Value |
|---------|-------|
| Provider | `oidc` |
| Issuer URL | `https://auth.home-infra.net` |
| Scopes | `openid profile email` |

### Cookie Settings

| Setting | Value |
|---------|-------|
| Cookie Name | `_oauth2_proxy` |
| Cookie Secure | `true` |
| Cookie SameSite | `lax` |
| Cookie Domains | `.home-infra.net` |

### Header Injection

When authentication succeeds, oauth2-proxy adds these headers to requests:

| Header | Description |
|--------|-------------|
| `X-Auth-Request-User` | Authenticated username |
| `X-Auth-Request-Email` | User's email address |
| `X-Auth-Request-Preferred-Username` | Preferred username |
| `X-Auth-Request-Access-Token` | OAuth access token |
| `Authorization` | Bearer token (when `pass_authorization_header=true`) |

---

## Credential Management

OIDC credentials are automatically managed:

1. **Cookie Secret**: Manually managed in SOPS (`oauth2-proxy-secrets`)
2. **Client ID/Secret**: Auto-generated by CronJob from Zitadel API

```yaml
# SOPS-managed secret (stable)
oauth2-proxy-secrets:
  cookie-secret: <base64-encoded-32-byte-key>

# CronJob-managed secret (auto-rotated)
oauth2-proxy-oidc-secrets:
  client-id: <generated>
  client-secret: <generated>
```

---

## Integration with Cilium ext_authz

oauth2-proxy is configured for forward auth mode:

```yaml
# Returns 200 on successful auth (not redirect)
upstreams = ["static://200"]

# Reverse proxy mode trusts X-Forwarded headers
reverse_proxy = true

# Skip provider button (direct to Zitadel)
skip_provider_button = true
```

### CiliumEnvoyConfig

To protect a service with oauth2-proxy:

```yaml
apiVersion: cilium.io/v2
kind: CiliumEnvoyConfig
metadata:
  name: protected-app-auth
  namespace: app-namespace
spec:
  services:
    - name: protected-app
      namespace: app-namespace
  backendServices:
    - name: oauth2-proxy
      namespace: auth
      port:
        port: 4180
  resources:
    - "@type": type.googleapis.com/envoy.config.listener.v3.Listener
      # ... ext_authz configuration
```

---

## Common Operations

### View Logs

```bash
# oauth2-proxy logs
kubectl logs -n auth deployment/oauth2-proxy --tail=100

# Check for auth failures
kubectl logs -n auth deployment/oauth2-proxy | grep -i error
```

### Test Authentication

```bash
# Check oauth2-proxy health
kubectl exec -n auth deployment/oauth2-proxy -- \
  wget -qO- http://localhost:4180/ping

# Verify OIDC discovery
kubectl exec -n auth deployment/oauth2-proxy -- \
  wget -qO- https://auth.home-infra.net/.well-known/openid-configuration
```

### Regenerate Cookie Secret

```bash
# Generate new 32-byte secret
NEW_SECRET=$(openssl rand -base64 32)

# Update SOPS secret
sops -d secrets/auth/oauth2-proxy-secrets.yaml > /tmp/secret.yaml
# Edit cookie-secret value
sops -e /tmp/secret.yaml > secrets/auth/oauth2-proxy-secrets.yaml
rm /tmp/secret.yaml

# Apply and restart
kubectl apply -f secrets/auth/oauth2-proxy-secrets.enc.yaml
kubectl rollout restart deployment/oauth2-proxy -n auth
```

---

## Verification

```bash
# Check oauth2-proxy pods
kubectl get pods -n auth -l app.kubernetes.io/name=oauth2-proxy

# Check service
kubectl get svc -n auth oauth2-proxy

# Verify OIDC credentials exist
kubectl get secret -n auth oauth2-proxy-oidc-secrets

# Test health endpoint
kubectl port-forward -n auth svc/oauth2-proxy 4180:4180 &
curl -s http://localhost:4180/ping
```

---

## Troubleshooting

### Authentication Loop

```bash
# Check cookie domain matches request domain
kubectl get configmap -n auth oauth2-proxy -o yaml | grep cookie_domains

# Verify redirect URIs in Zitadel match
# Login to https://auth.home-infra.net and check application config
```

### 403 Forbidden

```bash
# Check email domain restrictions
kubectl get configmap -n auth oauth2-proxy -o yaml | grep email_domains

# Verify user exists in Zitadel with correct email
```

### OIDC Credentials Missing

```bash
# Check CronJob status
kubectl get cronjob -n auth

# Check CronJob logs
kubectl logs -n auth job/$(kubectl get jobs -n auth -o name | tail -1)

# Manually trigger credential generation
kubectl create job --from=cronjob/oauth2-proxy-oidc-setup manual-oidc -n auth
```

### ext_authz Not Working

```bash
# Check CiliumEnvoyConfig
kubectl get ciliumenvoyconfig -A

# Check Envoy logs
kubectl logs -n kube-system -l app.kubernetes.io/name=cilium-envoy --tail=50

# Verify oauth2-proxy is reachable from Envoy
kubectl exec -n kube-system ds/cilium -- \
  curl -s http://oauth2-proxy.auth.svc.cluster.local:4180/ping
```

---

## Resources

| Resource | Requests | Limits |
|----------|----------|--------|
| CPU | 10m | - |
| Memory | 32Mi | 128Mi |

---

## Secrets

| Secret | Keys | Purpose |
|--------|------|---------|
| `oauth2-proxy-secrets` | `cookie-secret` | Session encryption (SOPS-managed) |
| `oauth2-proxy-oidc-secrets` | `client-id`, `client-secret` | OIDC credentials (CronJob-managed) |

---

## Documentation

- [oauth2-proxy Documentation](https://oauth2-proxy.github.io/oauth2-proxy/)
- [Configuration Reference](https://oauth2-proxy.github.io/oauth2-proxy/configuration/overview)
- [OIDC Provider Setup](https://oauth2-proxy.github.io/oauth2-proxy/configuration/providers/oidc)
- [Cilium ext_authz](https://docs.cilium.io/en/stable/network/servicemesh/envoy-traffic-management/)

---

**Last Updated:** 2026-01-28
