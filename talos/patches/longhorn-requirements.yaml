# Talos Machine Config Patch for Longhorn Storage Manager
#
# This patch adds necessary machine configuration for Longhorn to work on Talos Linux:
# 1. Kernel modules (nbd, iscsi_tcp, iscsi_generic, configfs)
# 2. Kubelet extra mounts for Longhorn data path
#
# IMPORTANT: System extensions (iscsi-tools, util-linux-tools) MUST be included
# in your Talos image via Talos Factory schematic. They CANNOT be added via patches.
# See packer/talos/README.md for instructions on generating a schematic with
# required extensions.
#
# Usage:
#   Apply this patch when generating or updating Talos machine configuration:
#   talosctl gen config ... --config-patch @talos/patches/longhorn-requirements.yaml
#   OR
#   talosctl patch machineconfig --patch @talos/patches/longhorn-requirements.yaml
#
# Talos Version: v1.8+
# Longhorn Version: v1.7+
# Last Updated: 2025-11-23

machine:
  # Kernel modules required by Longhorn
  kernel:
    modules:
      # Network Block Device - used by Longhorn for volume access
      - name: nbd
      # iSCSI modules - required for persistent volume operations
      - name: iscsi_tcp
      - name: iscsi_generic
      # ConfigFS - required for iSCSI target configuration
      - name: configfs

  # Kubelet extra mounts - critical for Longhorn volume attachment
  kubelet:
    extraMounts:
      # Longhorn data path with propagation mode 'rshared'
      # This allows volume mounts to propagate between host and containers
      - destination: /var/lib/longhorn
        type: bind
        source: /var/lib/longhorn
        options:
          - bind
          - rshared
          - rw

# NOTE: System extensions (iscsi-tools, util-linux-tools) must be included
# in the Talos Factory schematic when building the image. They cannot be added
# via machine config patches. See packer/talos/README.md for details.
