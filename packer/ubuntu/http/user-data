#cloud-config
# Ubuntu Autoinstall Configuration
# Automated installation for Ubuntu 24.04 LTS (Noble)
# Used by Packer to create golden image

autoinstall:
  version: 1

  # Locale and keyboard
  locale: en_US.UTF-8
  keyboard:
    layout: us
    variant: ''

  # Network configuration
  network:
    network:
      version: 2
      ethernets:
        any:
          match:
            name: en*
          dhcp4: true
          dhcp6: false

  # Storage configuration
  storage:
    layout:
      name: direct
      match:
        size: largest

  # Identity (temporary user for Packer provisioning)
  identity:
    hostname: ubuntu
    username: ubuntu
    password: $6$rounds=4096$saltsalt$YhXjWx6mPLH3wXmPDqH2qM0zBEDNF8gOJNpQx9DVFM4LlJ7wKEUxLx.oGXjJj0yp0FBkKJj4LHDN8oGXjJj0yp0
    # Password: ubuntu (hashed with mkpasswd -m sha-512)

  # SSH configuration
  ssh:
    install-server: true
    allow-pw: true

  # Package installation
  packages:
    - qemu-guest-agent
    - cloud-init
    - cloud-initramfs-growroot
    - sudo
    - openssh-server

  # User data
  user-data:
    disable_root: true
    users:
      - name: ubuntu
        groups: [adm, cdrom, dip, plugdev, sudo]
        lock_passwd: false
        passwd: $6$rounds=4096$saltsalt$YhXjWx6mPLH3wXmPDqH2qM0zBEDNF8gOJNpQx9DVFM4LlJ7wKEUxLx.oGXjJj0yp0FBkKJj4LHDN8oGXjJj0yp0
        shell: /bin/bash
        sudo: ALL=(ALL) NOPASSWD:ALL

  # Late commands (run after installation, before reboot)
  late-commands:
    - echo 'ubuntu ALL=(ALL) NOPASSWD:ALL' > /target/etc/sudoers.d/ubuntu
    - chmod 0440 /target/etc/sudoers.d/ubuntu
    - curtin in-target --target=/target -- systemctl enable ssh
    - curtin in-target --target=/target -- systemctl enable qemu-guest-agent
