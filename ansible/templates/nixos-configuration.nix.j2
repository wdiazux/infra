# NixOS Baseline Configuration
# Generated by Ansible playbook: day1-nixos-baseline.yml
# Hostname: {{ inventory_hostname }}
# Generated: {{ ansible_date_time.iso8601 }}

{ config, pkgs, ... }:

{
  imports =
    [ # Include the results of the hardware scan.
      ./hardware-configuration.nix
    ];

  # Boot loader configuration
  boot.loader.systemd-boot.enable = true;
  boot.loader.efi.canTouchEfiVariables = true;

  # Networking
  networking.hostName = "{{ inventory_hostname.split('.')[0] }}";
  networking.networkmanager.enable = false;  # Using systemd-networkd
  networking.useDHCP = false;

  # Systemd-networkd configuration
  systemd.network.enable = true;
  systemd.network.networks."10-lan" = {
    matchConfig.Name = "ens*";
    networkConfig = {
      DHCP = "ipv4";
      DNS = [ "8.8.8.8" "8.8.4.4" ];
    };
  };

  # Set your time zone
  time.timeZone = "{{ timezone }}";

  # Select internationalisation properties
  i18n.defaultLocale = "{{ locale }}";
  i18n.extraLocaleSettings = {
    LC_ADDRESS = "{{ locale }}";
    LC_IDENTIFICATION = "{{ locale }}";
    LC_MEASUREMENT = "{{ locale }}";
    LC_MONETARY = "{{ locale }}";
    LC_NAME = "{{ locale }}";
    LC_NUMERIC = "{{ locale }}";
    LC_PAPER = "{{ locale }}";
    LC_TELEPHONE = "{{ locale }}";
    LC_TIME = "{{ locale }}";
  };

  # System packages
  environment.systemPackages = with pkgs; [
{% for package in baseline_packages %}
    {{ package }}
{% endfor %}
  ];

  # Enable the OpenSSH daemon
  services.openssh = {
    enable = true;
    settings = {
      PermitRootLogin = "no";
      PasswordAuthentication = false;
      PubkeyAuthentication = true;
      X11Forwarding = false;
      MaxAuthTries = 3;
      ClientAliveInterval = 300;
      ClientAliveCountMax = 2;
    };
  };

  # Firewall configuration
  networking.firewall = {
    enable = true;
    allowedTCPPorts = [ {{ firewall_allowed_ports | join(' ') }} ];
  };

  # Fail2ban configuration
  services.fail2ban = {
    enable = true;
    maxretry = 5;
    bantime = "1h";
    ignoreIP = [ "127.0.0.1/8" ];
    jails = {
      sshd = ''
        enabled = true
        port = ssh
        filter = sshd
        logpath = /var/log/auth.log
        maxretry = 5
        findtime = 10m
        bantime = 1h
      '';
    };
  };

  # Automatic system upgrades
  system.autoUpgrade = {
    enable = true;
    allowReboot = false;
    dates = "daily";
    randomizedDelaySec = "45min";
  };

  # Automatic garbage collection
  nix.gc = {
    automatic = true;
    dates = "weekly";
    options = "--delete-older-than 30d";
  };

{% if enable_docker %}
  # Docker configuration
  virtualisation.docker = {
    enable = true;
    enableOnBoot = true;
  };
{% endif %}

{% if enable_podman %}
  # Podman configuration
  virtualisation.podman = {
    enable = true;
    dockerCompat = true;
    defaultNetwork.settings.dns_enabled = true;
  };
{% endif %}

  # NFS client support
  services.rpcbind.enable = true;
  boot.supportedFilesystems = [ "nfs" ];

  # System state version (DO NOT CHANGE)
  # This value determines the NixOS release from which the default
  # settings for stateful data, like file locations and database versions
  # on your system were taken. It's fine to change this when updating
  # to a new NixOS release, but do so carefully.
  system.stateVersion = "24.05"; # Did you read the comment?

  # Additional system-wide configuration
  security.sudo.wheelNeedsPassword = true;

  # Enable QEMU guest agent
  services.qemuGuest.enable = true;

  # Performance tuning
  boot.kernel.sysctl = {
    "vm.swappiness" = 10;
    "net.ipv4.tcp_keepalive_time" = 600;
    "net.core.somaxconn" = 1024;
  };
}
