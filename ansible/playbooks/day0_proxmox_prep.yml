# Day 0: Proxmox Host Preparation
#
# This playbook prepares the Proxmox VE host for VM deployments with GPU passthrough
# Based on best practices from:
# - lae.proxmox Ansible role
# - Proxmox VE Helper-Scripts (community-scripts/ProxmoxVE)
# - Official Proxmox documentation
#
# Run with: ansible-playbook playbooks/day0_proxmox_prep.yml
# Run specific sections: ansible-playbook playbooks/day0_proxmox_prep.yml --tags "repos,updates"
#
# Prerequisites:
# - Proxmox VE 8.x or 9.0+ installed
# - SSH access to Proxmox host as root
# - IOMMU support in BIOS (VT-d for Intel, AMD-Vi for AMD) if using GPU passthrough

---
- name: Prepare Proxmox Host with GPU Passthrough Support
  hosts: proxmox
  gather_facts: yes
  become: yes

  vars:
    # GRUB configuration based on CPU vendor
    grub_cmdline_amd: "quiet amd_iommu=on iommu=pt"
    grub_cmdline_intel: "quiet intel_iommu=on iommu=pt"

    # Kernel modules for VFIO (GPU passthrough)
    vfio_modules:
      - vfio
      - vfio_iommu_type1
      - vfio_pci
      - vfio_virqfd

    # Modules to blacklist (prevent host from using GPU)
    blacklist_modules:
      - nvidia
      - nouveau
      - nvidiafb

    # Repository configuration (override in group_vars)
    proxmox_disable_enterprise_repo: true
    proxmox_enable_no_subscription_repo: true
    proxmox_remove_subscription_nag: true
    proxmox_enable_ceph_repo: false
    proxmox_enable_pvetest_repo: false

    # HA services configuration
    proxmox_disable_ha_services: true  # Set to false for clustered setups

    # System configuration
    proxmox_update_system: true
    proxmox_install_essential_packages: true
    proxmox_configure_firewall: true
    proxmox_configure_ntp: true

    # Essential packages for Ansible automation
    essential_packages:
      - python3-proxmoxer
      - python3-requests
      - libsasl2-modules
      - curl
      - wget
      - vim
      - git
      - htop

    # GPU passthrough configuration (override in inventory or group_vars)
    has_gpu: false  # Set to true if this Proxmox host has NVIDIA GPU for passthrough

  tasks:
    # ========================================================================
    # System Information
    # ========================================================================

    - name: Display system information
      ansible.builtin.debug:
        msg: |
          Proxmox Host: {{ ansible_hostname }}
          CPU: {{ ansible_processor[2] if ansible_processor is defined else 'Unknown' }}
          Vendor: {{ detected_cpu_vendor | default('Unknown') }}
          Memory: {{ ansible_memtotal_mb }}MB
          Kernel: {{ ansible_kernel }}
          Distribution: {{ ansible_distribution }} {{ ansible_distribution_version }}
      tags: [always]

    # ========================================================================
    # Prerequisites Check
    # ========================================================================

    - name: Check if Proxmox VE is installed
      ansible.builtin.command: pveversion
      register: pve_version
      changed_when: false
      failed_when: false

    - name: Verify Proxmox VE 9.0+
      ansible.builtin.assert:
        that:
          - pve_version.rc == 0
          - "'pve-manager/9' in pve_version.stdout or 'pve-manager/8' in pve_version.stdout"
        fail_msg: "Proxmox VE 9.0+ required (or 8.x acceptable)"
        success_msg: "Proxmox VE version: {{ pve_version.stdout }}"

    - name: Check CPU vendor
      ansible.builtin.set_fact:
        detected_cpu_vendor: "{{ 'amd' if 'AMD' in ansible_processor[2] else 'intel' if 'Intel' in ansible_processor[2] else 'unknown' }}"

    - name: Validate CPU vendor
      ansible.builtin.assert:
        that:
          - detected_cpu_vendor != 'unknown'
        fail_msg: "Could not detect CPU vendor (AMD or Intel required)"
        success_msg: "Detected CPU vendor: {{ detected_cpu_vendor }}"
      tags: [always]

    - name: Detect Proxmox version (8.x or 9.x)
      ansible.builtin.set_fact:
        proxmox_major_version: "{{ pve_version.stdout.split('/')[1].split('.')[0] }}"
      tags: [always]

    - name: Display Proxmox major version
      ansible.builtin.debug:
        msg: "Proxmox VE major version: {{ proxmox_major_version }}"
      tags: [always]

    # ========================================================================
    # Repository Management (Proxmox 8.x and 9.x)
    # ========================================================================

    - name: Disable pve-enterprise repository (Proxmox 8.x .list format)
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list.d/pve-enterprise.list
        regexp: '^deb https://enterprise.proxmox.com'
        line: '# deb https://enterprise.proxmox.com/debian/pve bookworm pve-enterprise'
        backup: yes
      when:
        - proxmox_disable_enterprise_repo | bool
        - proxmox_major_version == "8"
      tags: [repos]

    - name: Disable pve-enterprise repository (Proxmox 9.x .sources format)
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list.d/pve-enterprise.sources
        regexp: '^Enabled:'
        line: 'Enabled: no'
        backup: yes
      when:
        - proxmox_disable_enterprise_repo | bool
        - proxmox_major_version == "9"
      failed_when: false
      tags: [repos]

    - name: Enable pve-no-subscription repository (Proxmox 8.x)
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/pve-no-subscription.list
        content: |
          # Proxmox VE No-Subscription Repository (free updates)
          deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription
        mode: '0644'
        backup: yes
      when:
        - proxmox_enable_no_subscription_repo | bool
        - proxmox_major_version == "8"
      tags: [repos]

    - name: Enable pve-no-subscription repository (Proxmox 9.x)
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/pve-no-subscription.sources
        content: |
          # Proxmox VE No-Subscription Repository (free updates)
          Types: deb
          URIs: http://download.proxmox.com/debian/pve
          Suites: bookworm
          Components: pve-no-subscription
          Enabled: yes
        mode: '0644'
        backup: yes
      when:
        - proxmox_enable_no_subscription_repo | bool
        - proxmox_major_version == "9"
      tags: [repos]

    - name: Enable Ceph repository (Proxmox 8.x)
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/ceph.list
        content: |
          # Ceph Reef Repository
          deb http://download.proxmox.com/debian/ceph-reef bookworm no-subscription
        mode: '0644'
        backup: yes
      when:
        - proxmox_enable_ceph_repo | bool
        - proxmox_major_version == "8"
      tags: [repos, ceph]

    - name: Enable Ceph repository (Proxmox 9.x)
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/ceph.sources
        content: |
          # Ceph Squid Repository
          Types: deb
          URIs: http://download.proxmox.com/debian/ceph-squid
          Suites: bookworm
          Components: no-subscription
          Enabled: yes
        mode: '0644'
        backup: yes
      when:
        - proxmox_enable_ceph_repo | bool
        - proxmox_major_version == "9"
      tags: [repos, ceph]

    - name: Configure pvetest repository (disabled by default)
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/pvetest.list
        content: |
          # Proxmox VE Testing Repository (disabled by default)
          # deb http://download.proxmox.com/debian/pve bookworm pvetest
        mode: '0644'
        backup: yes
      when: proxmox_enable_pvetest_repo | bool
      tags: [repos, testing]

    - name: Update APT cache after repository changes
      ansible.builtin.apt:
        update_cache: yes
      when: proxmox_disable_enterprise_repo | bool or proxmox_enable_no_subscription_repo | bool
      tags: [repos]

    # ========================================================================
    # Essential Packages Installation
    # ========================================================================

    - name: Install essential packages for Ansible automation
      ansible.builtin.apt:
        name: "{{ essential_packages }}"
        state: present
        update_cache: yes
      when: proxmox_install_essential_packages | bool
      tags: [packages]

    # ========================================================================
    # Subscription Nag Removal
    # ========================================================================

    - name: Check if proxmox-widget-toolkit is installed
      ansible.builtin.command: dpkg -l proxmox-widget-toolkit
      register: widget_toolkit_check
      changed_when: false
      failed_when: false
      when: proxmox_remove_subscription_nag | bool
      tags: [nag]

    - name: Remove subscription nag from web UI
      ansible.builtin.replace:
        path: /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
        regexp: "Ext\\.Msg\\.show\\(\\{[\\s\\S]*?checked_command: function"
        replace: "void({ //Ext.Msg.show({\nchecked_command: function"
        backup: yes
      when:
        - proxmox_remove_subscription_nag | bool
        - widget_toolkit_check.rc == 0
      notify: Restart pveproxy
      tags: [nag]

    # ========================================================================
    # HA Services Configuration
    # ========================================================================

    - name: Disable HA services for single-node setup
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: no
        state: stopped
      loop:
        - pve-ha-lrm
        - pve-ha-crm
        - corosync
      when: proxmox_disable_ha_services | bool
      failed_when: false  # Don't fail if services don't exist
      tags: [ha]

    - name: Enable HA services for clustered setup
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: yes
        state: started
      loop:
        - pve-ha-lrm
        - pve-ha-crm
        - corosync
      when: not (proxmox_disable_ha_services | bool)
      failed_when: false
      tags: [ha]

    # ========================================================================
    # System Updates
    # ========================================================================

    - name: Perform system update (apt upgrade)
      ansible.builtin.apt:
        upgrade: dist
        update_cache: yes
        autoremove: yes
        autoclean: yes
      when: proxmox_update_system | bool
      tags: [updates]

    # ========================================================================
    # Firewall Configuration
    # ========================================================================

    - name: Configure UFW firewall
      block:
        - name: Install UFW if not present
          ansible.builtin.apt:
            name: ufw
            state: present

        - name: Allow SSH through firewall
          community.general.ufw:
            rule: allow
            port: '22'
            proto: tcp

        - name: Allow Proxmox web interface
          community.general.ufw:
            rule: allow
            port: '8006'
            proto: tcp

        - name: Allow SPICE proxy
          community.general.ufw:
            rule: allow
            port: '3128'
            proto: tcp

        - name: Allow VNC connections
          community.general.ufw:
            rule: allow
            port: '5900:5999'
            proto: tcp

        - name: Enable UFW
          community.general.ufw:
            state: enabled
      when: proxmox_configure_firewall | bool
      tags: [firewall]

    # ========================================================================
    # Time Synchronization
    # ========================================================================

    - name: Configure chrony for time synchronization
      block:
        - name: Install chrony
          ansible.builtin.apt:
            name: chrony
            state: present

        - name: Ensure chrony is running and enabled
          ansible.builtin.systemd:
            name: chronyd
            enabled: yes
            state: started
      when: proxmox_configure_ntp | bool
      tags: [ntp]

    # ========================================================================
    # IOMMU Configuration
    # ========================================================================

    - name: Check if IOMMU is already enabled
      ansible.builtin.shell: dmesg | grep -i iommu | grep -i enabled
      register: iommu_check
      changed_when: false
      failed_when: false
      tags: [iommu, gpu]

    - name: Display current IOMMU status
      ansible.builtin.debug:
        msg: "IOMMU Status: {{ 'Enabled' if iommu_check.rc == 0 else 'Not Enabled' }}"
      tags: [iommu, gpu]

    - name: Read current GRUB configuration
      ansible.builtin.slurp:
        src: /etc/default/grub
      register: grub_config
      tags: [iommu, gpu]

    - name: Parse GRUB cmdline
      ansible.builtin.set_fact:
        current_grub_cmdline: "{{ (grub_config['content'] | b64decode | regex_search('GRUB_CMDLINE_LINUX_DEFAULT=\"(.*)\"', '\\1') | first) if grub_config['content'] is defined else '' }}"
      tags: [iommu, gpu]

    - name: Set target GRUB cmdline based on CPU vendor
      ansible.builtin.set_fact:
        target_grub_cmdline: "{{ grub_cmdline_amd if detected_cpu_vendor == 'amd' else grub_cmdline_intel }}"
      tags: [iommu, gpu]

    - name: Update GRUB configuration for IOMMU
      ansible.builtin.lineinfile:
        path: /etc/default/grub
        regexp: '^GRUB_CMDLINE_LINUX_DEFAULT='
        line: 'GRUB_CMDLINE_LINUX_DEFAULT="{{ target_grub_cmdline }}"'
        backup: yes
      register: grub_updated
      notify: Update GRUB
      tags: [iommu, gpu]

    - name: Display GRUB update status
      ansible.builtin.debug:
        msg: "GRUB configuration {{ 'updated' if grub_updated.changed else 'already correct' }}"
      tags: [iommu, gpu]

    # ========================================================================
    # VFIO Kernel Modules
    # ========================================================================

    - name: Load VFIO kernel modules
      ansible.builtin.modprobe:
        name: "{{ item }}"
        state: present
      loop: "{{ vfio_modules }}"
      when: has_gpu | default(false)
      tags: [vfio, gpu]

    - name: Configure VFIO modules to load at boot
      ansible.builtin.lineinfile:
        path: /etc/modules
        line: "{{ item }}"
        create: yes
      loop: "{{ vfio_modules }}"
      when: has_gpu | default(false)
      tags: [vfio, gpu]

    # ========================================================================
    # Blacklist GPU Drivers on Host
    # ========================================================================

    - name: Create blacklist configuration for GPU drivers
      ansible.builtin.copy:
        dest: /etc/modprobe.d/blacklist-gpu.conf
        content: |
          # Blacklist GPU drivers to prevent host from using GPU
          # GPU will be passed through to VMs instead
          {% for module in blacklist_modules %}
          blacklist {{ module }}
          {% endfor %}
        mode: '0644'
      when: has_gpu | default(false)
      notify: Update initramfs
      tags: [vfio, gpu]

    # ========================================================================
    # ZFS Configuration
    # ========================================================================

    - name: Check if ZFS is installed
      ansible.builtin.command: zpool status
      register: zfs_check
      changed_when: false
      failed_when: false
      tags: [zfs, storage]

    - name: Configure ZFS ARC memory limit
      ansible.builtin.lineinfile:
        path: /etc/modprobe.d/zfs.conf
        line: "options zfs zfs_arc_max={{ (zfs_arc_max_gb | default(16)) * 1024 * 1024 * 1024 }}"
        create: yes
        regexp: '^options zfs zfs_arc_max='
      when: zfs_check.rc == 0
      notify: Update initramfs
      tags: [zfs, storage]

    - name: Display ZFS configuration
      ansible.builtin.debug:
        msg: "ZFS ARC max: {{ zfs_arc_max_gb | default(16) }}GB"
      when: zfs_check.rc == 0
      tags: [zfs, storage]

    # ========================================================================
    # Network Configuration
    # ========================================================================

    - name: Verify network bridge exists
      ansible.builtin.command: ip link show vmbr0
      register: bridge_check
      changed_when: false
      failed_when: false
      tags: [network]

    - name: Display bridge status
      ansible.builtin.debug:
        msg: "Network bridge vmbr0: {{ 'Present' if bridge_check.rc == 0 else 'Not Found - create manually in Proxmox' }}"
      tags: [network]

    # ========================================================================
    # GPU Information
    # ========================================================================

    - name: Get GPU information
      ansible.builtin.shell: lspci | grep -i vga | grep -i nvidia
      register: gpu_info
      changed_when: false
      failed_when: false
      when: has_gpu | default(false)
      tags: [gpu, info]

    - name: Display GPU information
      ansible.builtin.debug:
        msg: "GPU detected: {{ gpu_info.stdout if gpu_info.rc == 0 else 'No NVIDIA GPU found' }}"
      when: has_gpu | default(false)
      tags: [gpu, info]

    - name: Get GPU PCI ID
      ansible.builtin.shell: lspci | grep -i nvidia | awk '{print $1}'
      register: gpu_pci
      changed_when: false
      failed_when: false
      when: has_gpu | default(false)
      tags: [gpu, info]

    - name: Display GPU PCI ID for Terraform
      ansible.builtin.debug:
        msg: |
          GPU PCI ID for Terraform configuration: {{ gpu_pci.stdout.split('.')[0] if gpu_pci.rc == 0 else 'Not detected' }}
          Use this in terraform/terraform.tfvars: gpu_pci_id = "{{ gpu_pci.stdout.split('.')[0] }}"
      when: has_gpu | default(false)
      tags: [gpu, info]

    # ========================================================================
    # Verify IOMMU Groups
    # ========================================================================

    - name: List IOMMU groups
      ansible.builtin.shell: find /sys/kernel/iommu_groups/ -type l | sort -V
      register: iommu_groups
      changed_when: false
      failed_when: false
      tags: [iommu, gpu, info]

    - name: Display IOMMU group count
      ansible.builtin.debug:
        msg: "IOMMU groups found: {{ iommu_groups.stdout_lines | length if iommu_groups.rc == 0 else '0 (IOMMU not enabled or requires reboot)' }}"
      tags: [iommu, gpu, info]

    # ========================================================================
    # Post-Configuration Summary
    # ========================================================================

    - name: Display post-configuration summary
      ansible.builtin.debug:
        msg: |
          ============================================================
          Proxmox Host Preparation Complete
          ============================================================

          System Information:
          - Host: {{ ansible_hostname }}
          - Proxmox Version: {{ pve_version.stdout }} ({{ proxmox_major_version }}.x)
          - CPU Vendor: {{ detected_cpu_vendor }}
          - Memory: {{ ansible_memtotal_mb }}MB

          Repository Configuration:
          - Enterprise repo disabled: {{ proxmox_disable_enterprise_repo }}
          - No-subscription repo enabled: {{ proxmox_enable_no_subscription_repo }}
          - Subscription nag removed: {{ proxmox_remove_subscription_nag }}
          - Ceph repo enabled: {{ proxmox_enable_ceph_repo }}

          System Updates:
          - System updated: {{ proxmox_update_system }}
          - Essential packages installed: {{ proxmox_install_essential_packages }}

          HA Services:
          - HA services disabled: {{ proxmox_disable_ha_services }}

          Security:
          - Firewall configured: {{ proxmox_configure_firewall }}
          - NTP configured: {{ proxmox_configure_ntp }}

          IOMMU Configuration:
          - Target GRUB cmdline: {{ target_grub_cmdline }}
          - GRUB updated: {{ grub_updated.changed }}
          - VFIO modules configured: {{ has_gpu | default(false) }}

          GPU Configuration:
          - GPU passthrough enabled: {{ has_gpu | default(false) }}
          {% if has_gpu | default(false) and gpu_info.rc == 0 %}
          - GPU detected: {{ gpu_info.stdout }}
          - PCI ID: {{ gpu_pci.stdout.split('.')[0] }}
          {% endif %}

          ZFS Configuration:
          - ZFS installed: {{ zfs_check.rc == 0 }}
          {% if zfs_check.rc == 0 %}
          - ARC max: {{ zfs_arc_max_gb | default(16) }}GB
          {% endif %}

          Network:
          - Bridge vmbr0: {{ 'Present' if bridge_check.rc == 0 else 'Not Found' }}

          ============================================================
          IMPORTANT: Reboot Required!
          ============================================================
          {% if grub_updated.changed or proxmox_remove_subscription_nag %}
          {% if grub_updated.changed %}
          GRUB configuration was updated. Reboot Proxmox host to apply changes:
          {% endif %}
          {% if proxmox_remove_subscription_nag %}
          Subscription nag was removed. Clear browser cache and reboot:
          {% endif %}

            ssh root@{{ ansible_host }} reboot

          After reboot:
          - Verify IOMMU is enabled: dmesg | grep -i iommu | grep -i enabled
          - Clear browser cache before accessing Proxmox web UI

          {% else %}
          No critical changes requiring reboot were made.
          {% endif %}

          Next Steps:
          1. Reboot Proxmox host (if required)
          2. Verify IOMMU is enabled (if using GPU passthrough)
          3. Clear browser cache (if subscription nag was removed)
          4. Build VM templates with Packer (cd packer/<os> && packer build .)
          5. Deploy VMs with Terraform (cd terraform && terraform apply)

          ============================================================
      tags: [always]

  handlers:
    - name: Update GRUB
      ansible.builtin.command: update-grub
      listen: Update GRUB

    - name: Update initramfs
      ansible.builtin.command: update-initramfs -u
      listen: Update initramfs

    - name: Restart pveproxy
      ansible.builtin.systemd:
        name: pveproxy
        state: restarted
      listen: Restart pveproxy

# Notes:
# - This playbook is IDEMPOTENT - safe to run multiple times
# - Reboot is required after GRUB changes
# - GPU passthrough requires IOMMU support in BIOS/UEFI
# - VFIO modules are loaded but won't work until after reboot with IOMMU enabled
# - ZFS ARC limit prevents memory starvation on Proxmox host
# - Blacklisting GPU drivers prevents host from using the GPU (VM passthrough only)
