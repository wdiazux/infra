# Day 0: Proxmox Host Preparation
#
# This playbook prepares the Proxmox VE host for VM deployments with GPU passthrough
# Based on best practices from:
# - lae.proxmox Ansible role
# - Proxmox VE Helper-Scripts (community-scripts/ProxmoxVE)
# - Official Proxmox documentation
#
# Run with: ansible-playbook playbooks/day0_proxmox_prep.yml
# Run specific sections: ansible-playbook playbooks/day0_proxmox_prep.yml --tags "repos,updates"
#
# Prerequisites:
# - Proxmox VE 8.x or 9.0+ installed
# - SSH access to Proxmox host as root
# - IOMMU support in BIOS (VT-d for Intel, AMD-Vi for AMD) if using GPU passthrough

---
- name: Prepare Proxmox Host with GPU Passthrough Support
  hosts: proxmox
  gather_facts: true
  become: true

  vars:
    # GRUB configuration based on CPU vendor
    grub_cmdline_amd: "quiet amd_iommu=on iommu=pt"
    grub_cmdline_intel: "quiet intel_iommu=on iommu=pt"

    # Kernel modules for VFIO (GPU passthrough)
    # Note: vfio_virqfd was merged into vfio in kernel 6.2+
    vfio_modules:
      - vfio
      - vfio_iommu_type1
      - vfio_pci

    # Modules to blacklist (prevent host from using GPU)
    blacklist_modules:
      - nvidia
      - nouveau
      - nvidiafb

    # Repository configuration (override in group_vars)
    proxmox_disable_enterprise_repo: true
    proxmox_enable_no_subscription_repo: true
    proxmox_remove_subscription_nag: true
    proxmox_enable_ceph_repo: false
    proxmox_enable_pvetest_repo: false

    # HA services configuration
    proxmox_disable_ha_services: true  # Set to false for clustered setups

    # System configuration
    proxmox_update_system: true
    proxmox_install_essential_packages: true
    proxmox_configure_firewall: true
    proxmox_configure_ntp: true

    # Essential packages for Ansible automation
    essential_packages:
      - python3-proxmoxer
      - python3-requests
      - libsasl2-modules
      - curl
      - wget
      - vim
      - git
      - htop

    # GPU passthrough configuration (override in inventory or group_vars)
    has_gpu: false  # Set to true if this Proxmox host has NVIDIA GPU for passthrough

  tasks:
    - name: Display system information
      ansible.builtin.debug:
        msg: |
          Proxmox Host: {{ ansible_hostname }}
          CPU: {{ ansible_processor[2] if ansible_processor is defined else 'Unknown' }}
          Vendor: {{ detected_cpu_vendor | default('Unknown') }}
          Memory: {{ ansible_memtotal_mb }}MB
          Kernel: {{ ansible_kernel }}
          Distribution: {{ ansible_distribution }} {{ ansible_distribution_version }}
      tags: [always]

    - name: Check if Proxmox VE is installed
      ansible.builtin.command: pveversion
      register: pve_version
      changed_when: false
      failed_when: false

    - name: Verify Proxmox VE 9.0+
      ansible.builtin.assert:
        that:
          - pve_version.rc == 0
          - "'pve-manager/9' in pve_version.stdout or 'pve-manager/8' in pve_version.stdout"
        fail_msg: "Proxmox VE 9.0+ required (or 8.x acceptable)"
        success_msg: "Proxmox VE version: {{ pve_version.stdout }}"

    - name: Check CPU vendor
      ansible.builtin.set_fact:
        detected_cpu_vendor: "{{ 'amd' if 'AMD' in ansible_processor[2] else 'intel' if 'Intel' in ansible_processor[2] else 'unknown' }}"

    - name: Validate CPU vendor
      ansible.builtin.assert:
        that:
          - detected_cpu_vendor != 'unknown'
        fail_msg: "Could not detect CPU vendor (AMD or Intel required)"
        success_msg: "Detected CPU vendor: {{ detected_cpu_vendor }}"
      tags: [always]

    - name: Detect Proxmox version (8.x or 9.x)
      ansible.builtin.set_fact:
        proxmox_major_version: "{{ pve_version.stdout.split('/')[1].split('.')[0] }}"
      tags: [always]

    - name: Display Proxmox major version
      ansible.builtin.debug:
        msg: "Proxmox VE major version: {{ proxmox_major_version }}"
      tags: [always]

    - name: Disable pve-enterprise repository (Proxmox 8.x .list format)
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list.d/pve-enterprise.list
        regexp: '^deb https://enterprise.proxmox.com'
        line: '# deb https://enterprise.proxmox.com/debian/pve bookworm pve-enterprise'
        backup: true
      when:
        - proxmox_disable_enterprise_repo | bool
        - proxmox_major_version == "8"
      tags: [repos]

    - name: Disable pve-enterprise repository (Proxmox 9.x .sources format)
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list.d/pve-enterprise.sources
        regexp: '^Enabled:'
        line: 'Enabled: no'
        backup: true
      when:
        - proxmox_disable_enterprise_repo | bool
        - proxmox_major_version == "9"
      failed_when: false
      tags: [repos]

    - name: Enable pve-no-subscription repository (Proxmox 8.x)
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/pve-no-subscription.list
        content: |
          # Proxmox VE No-Subscription Repository (free updates)
          deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription
        mode: '0644'
        backup: true
      when:
        - proxmox_enable_no_subscription_repo | bool
        - proxmox_major_version == "8"
      tags: [repos]

    - name: Enable pve-no-subscription repository (Proxmox 9.x)
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/pve-no-subscription.sources
        content: |
          # Proxmox VE No-Subscription Repository (free updates)
          Types: deb
          URIs: http://download.proxmox.com/debian/pve
          Suites: bookworm
          Components: pve-no-subscription
          Enabled: yes
        mode: '0644'
        backup: true
      when:
        - proxmox_enable_no_subscription_repo | bool
        - proxmox_major_version == "9"
      tags: [repos]

    - name: Enable Ceph repository (Proxmox 8.x)
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/ceph.list
        content: |
          # Ceph Reef Repository
          deb http://download.proxmox.com/debian/ceph-reef bookworm no-subscription
        mode: '0644'
        backup: true
      when:
        - proxmox_enable_ceph_repo | bool
        - proxmox_major_version == "8"
      tags: [repos, ceph]

    - name: Enable Ceph repository (Proxmox 9.x)
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/ceph.sources
        content: |
          # Ceph Squid Repository
          Types: deb
          URIs: http://download.proxmox.com/debian/ceph-squid
          Suites: bookworm
          Components: no-subscription
          Enabled: yes
        mode: '0644'
        backup: true
      when:
        - proxmox_enable_ceph_repo | bool
        - proxmox_major_version == "9"
      tags: [repos, ceph]

    - name: Configure pvetest repository (disabled by default)
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/pvetest.list
        content: |
          # Proxmox VE Testing Repository (disabled by default)
          # deb http://download.proxmox.com/debian/pve bookworm pvetest
        mode: '0644'
        backup: true
      when: proxmox_enable_pvetest_repo | bool
      tags: [repos, testing]

    - name: Update APT cache after repository changes
      ansible.builtin.apt:
        update_cache: true
      when: proxmox_disable_enterprise_repo | bool or proxmox_enable_no_subscription_repo | bool
      tags: [repos]

    - name: Install essential packages for Ansible automation
      ansible.builtin.apt:
        name: "{{ essential_packages }}"
        state: present
        update_cache: true
      when: proxmox_install_essential_packages | bool
      tags: [packages]

    - name: Check if proxmox-widget-toolkit is installed
      ansible.builtin.command: dpkg -l proxmox-widget-toolkit
      register: widget_toolkit_check
      changed_when: false
      failed_when: false
      when: proxmox_remove_subscription_nag | bool
      tags: [nag]

    - name: Remove subscription nag from web UI
      ansible.builtin.replace:
        path: /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
        regexp: "Ext\\.Msg\\.show\\(\\{[\\s\\S]*?checked_command: function"
        replace: "void({ //Ext.Msg.show({\nchecked_command: function"
        backup: true
      when:
        - proxmox_remove_subscription_nag | bool
        - widget_toolkit_check.rc == 0
      notify: Restart pveproxy
      tags: [nag]

    - name: Disable HA services for single-node setup
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: false
        state: stopped
      loop:
        - pve-ha-lrm
        - pve-ha-crm
        - corosync
      when: proxmox_disable_ha_services | bool
      failed_when: false  # Don't fail if services don't exist
      tags: [ha]

    - name: Enable HA services for clustered setup
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - pve-ha-lrm
        - pve-ha-crm
        - corosync
      when: not (proxmox_disable_ha_services | bool)
      failed_when: false
      tags: [ha]

    - name: Perform system update (apt upgrade)
      ansible.builtin.apt:
        upgrade: dist
        update_cache: true
        autoremove: true
        autoclean: true
      when: proxmox_update_system | bool
      tags: [updates]

    - name: Configure UFW firewall
      when: proxmox_configure_firewall | bool
      tags: [firewall]
      block:
        - name: Install UFW if not present
          ansible.builtin.apt:
            name: ufw
            state: present

        - name: Allow SSH through firewall
          community.general.ufw:
            rule: allow
            port: '22'
            proto: tcp

        - name: Allow Proxmox web interface
          community.general.ufw:
            rule: allow
            port: '8006'
            proto: tcp

        - name: Allow SPICE proxy
          community.general.ufw:
            rule: allow
            port: '3128'
            proto: tcp

        - name: Allow VNC connections
          community.general.ufw:
            rule: allow
            port: '5900:5999'
            proto: tcp

        - name: Enable UFW
          community.general.ufw:
            state: enabled

    - name: Configure chrony for time synchronization
      when: proxmox_configure_ntp | bool
      tags: [ntp]
      block:
        - name: Install chrony
          ansible.builtin.apt:
            name: chrony
            state: present

        - name: Ensure chrony is running and enabled
          ansible.builtin.systemd:
            name: chronyd
            enabled: true
            state: started

    - name: Check if IOMMU is already enabled
      ansible.builtin.shell: |
        set -o pipefail
        dmesg | grep -i iommu | grep -i enabled
      args:
        executable: /bin/bash
      register: iommu_check
      changed_when: false
      failed_when: false
      tags: [iommu, gpu]

    - name: Display current IOMMU status
      ansible.builtin.debug:
        msg: "IOMMU Status: {{ 'Enabled' if iommu_check.rc == 0 else 'Not Enabled' }}"
      tags: [iommu, gpu]

    - name: Read current GRUB configuration
      ansible.builtin.slurp:
        src: /etc/default/grub
      register: grub_config
      tags: [iommu, gpu]

    - name: Parse GRUB cmdline
      ansible.builtin.set_fact:
        current_grub_cmdline: >-
          {{ (grub_config['content'] | b64decode |
              regex_search('GRUB_CMDLINE_LINUX_DEFAULT="(.*)"', '\1') | first)
              if grub_config['content'] is defined else '' }}
      tags: [iommu, gpu]

    - name: Set target GRUB cmdline based on CPU vendor
      ansible.builtin.set_fact:
        target_grub_cmdline: "{{ grub_cmdline_amd if detected_cpu_vendor == 'amd' else grub_cmdline_intel }}"
      tags: [iommu, gpu]

    - name: Update GRUB configuration for IOMMU
      ansible.builtin.lineinfile:
        path: /etc/default/grub
        regexp: '^GRUB_CMDLINE_LINUX_DEFAULT='
        line: 'GRUB_CMDLINE_LINUX_DEFAULT="{{ target_grub_cmdline }}"'
        backup: true
      register: grub_updated
      notify: Update GRUB
      tags: [iommu, gpu]

    - name: Display GRUB update status
      ansible.builtin.debug:
        msg: "GRUB configuration {{ 'updated' if grub_updated.changed else 'already correct' }}"
      tags: [iommu, gpu]

    - name: Load VFIO kernel modules
      community.general.modprobe:
        name: "{{ item }}"
        state: present
      loop: "{{ vfio_modules }}"
      when: has_gpu | default(false)
      tags: [vfio, gpu]

    - name: Configure VFIO modules to load at boot
      ansible.builtin.lineinfile:
        path: /etc/modules
        line: "{{ item }}"
        create: true
        mode: '0644'
      loop: "{{ vfio_modules }}"
      when: has_gpu | default(false)
      tags: [vfio, gpu]

    - name: Create blacklist configuration for GPU drivers
      ansible.builtin.copy:
        dest: /etc/modprobe.d/blacklist-gpu.conf
        content: |
          # Blacklist GPU drivers to prevent host from using GPU
          # GPU will be passed through to VMs instead
          {% for module in blacklist_modules %}
          blacklist {{ module }}
          {% endfor %}
        mode: '0644'
      when: has_gpu | default(false)
      notify: Update initramfs
      tags: [vfio, gpu]

    - name: Check if ZFS is installed
      ansible.builtin.command: zpool status
      register: zfs_check
      changed_when: false
      failed_when: false
      tags: [zfs, storage]

    - name: Configure ZFS ARC memory limit
      ansible.builtin.lineinfile:
        path: /etc/modprobe.d/zfs.conf
        line: "options zfs zfs_arc_max={{ (zfs_arc_max_gb | default(16)) * 1024 * 1024 * 1024 }}"
        create: true
        mode: '0644'
        regexp: '^options zfs zfs_arc_max='
      when: zfs_check.rc == 0
      notify: Update initramfs
      tags: [zfs, storage]

    - name: Display ZFS configuration
      ansible.builtin.debug:
        msg: "ZFS ARC max: {{ zfs_arc_max_gb | default(16) }}GB"
      when: zfs_check.rc == 0
      tags: [zfs, storage]

    - name: Verify network bridge exists
      ansible.builtin.command: ip link show vmbr0
      register: bridge_check
      changed_when: false
      failed_when: false
      tags: [network]

    - name: Display bridge status
      ansible.builtin.debug:
        msg: "Network bridge vmbr0: {{ 'Present' if bridge_check.rc == 0 else 'Not Found - create manually in Proxmox' }}"
      tags: [network]

    - name: Get GPU information
      ansible.builtin.shell: |
        set -o pipefail
        lspci | grep -i vga | grep -i nvidia
      args:
        executable: /bin/bash
      register: gpu_info
      changed_when: false
      failed_when: false
      when: has_gpu | default(false)
      tags: [gpu, info]

    - name: Display GPU information
      ansible.builtin.debug:
        msg: "GPU detected: {{ gpu_info.stdout if gpu_info.rc == 0 else 'No NVIDIA GPU found' }}"
      when: has_gpu | default(false)
      tags: [gpu, info]

    - name: Get GPU PCI ID
      ansible.builtin.shell: |
        set -o pipefail
        lspci | grep -i nvidia | awk '{print $1}'
      args:
        executable: /bin/bash
      register: gpu_pci
      changed_when: false
      failed_when: false
      when: has_gpu | default(false)
      tags: [gpu, info]

    - name: Display GPU PCI ID for Terraform
      ansible.builtin.debug:
        msg: |
          GPU PCI ID for Terraform configuration: {{ gpu_pci.stdout.split('.')[0] if gpu_pci.rc == 0 else 'Not detected' }}
          Use this in terraform/terraform.tfvars: gpu_pci_id = "{{ gpu_pci.stdout.split('.')[0] }}"
      when: has_gpu | default(false)
      tags: [gpu, info]

    - name: Check if terraform user exists
      ansible.builtin.command: pveum user list --output-format json
      register: pveum_users
      changed_when: false
      tags: [terraform, api]

    - name: Create terraform user for API access
      ansible.builtin.command: >
        pveum user add terraform@pve
        --comment "Terraform automation user"
      when: "'terraform@pve' not in pveum_users.stdout"
      tags: [terraform, api]

    - name: Grant PVEVMAdmin role to terraform user
      ansible.builtin.command: >
        pveum acl modify / -user terraform@pve -role PVEVMAdmin
      changed_when: false
      tags: [terraform, api]

    - name: Grant PVEDatastoreUser role to terraform user
      ansible.builtin.command: >
        pveum acl modify /storage -user terraform@pve -role PVEDatastoreUser
      changed_when: false
      tags: [terraform, api]

    - name: Check if terraform API token exists
      ansible.builtin.command: pveum user token list terraform@pve --output-format json
      register: terraform_tokens
      changed_when: false
      failed_when: false
      tags: [terraform, api]

    - name: Create terraform API token
      ansible.builtin.command: >
        pveum user token add terraform@pve terraform-token
        --privsep 0
        --comment "Terraform automation token"
      register: terraform_token_created
      when: "'terraform-token' not in (terraform_tokens.stdout | default(''))"
      tags: [terraform, api]

    - name: Display API token (SAVE THIS!)
      ansible.builtin.debug:
        msg: |
          ============================================================
          IMPORTANT: Save this API token securely!
          ============================================================
          {{ terraform_token_created.stdout }}

          Add to terraform/terraform.tfvars:
          proxmox_api_token = "terraform@pve!terraform-token=<token-value>"
          ============================================================
      when: terraform_token_created.changed | default(false)
      tags: [terraform, api]

    - name: Check if GPU resource mapping exists
      ansible.builtin.command: pvesh get /cluster/mapping/pci --output-format json
      register: pci_mappings
      changed_when: false
      failed_when: false
      when: has_gpu | default(false)
      tags: [gpu, terraform, mapping]

    - name: Get GPU vendor:device ID
      ansible.builtin.shell: |
        set -o pipefail
        lspci -nn | grep -i nvidia | head -1 | grep -oP '\[\K[0-9a-f]{4}:[0-9a-f]{4}(?=\])'
      args:
        executable: /bin/bash
      register: gpu_vendor_device
      changed_when: false
      when: has_gpu | default(false)
      tags: [gpu, terraform, mapping]

    - name: Get GPU subsystem ID
      ansible.builtin.shell: |
        set -o pipefail
        lspci -vnn -s {{ gpu_pci.stdout.split('\n')[0] }} | \
          grep -oP 'Subsystem:.*\[\K[0-9a-f]{4}:[0-9a-f]{4}(?=\])' | head -1
      args:
        executable: /bin/bash
      register: gpu_subsystem_id
      changed_when: false
      failed_when: false
      when: has_gpu | default(false)
      tags: [gpu, terraform, mapping]

    - name: Get GPU IOMMU group
      ansible.builtin.shell: |
        set -o pipefail
        GPU_ADDR=$(lspci | grep -i nvidia | grep -i vga | awk '{print $1}' | cut -d: -f1-2)
        readlink -f /sys/bus/pci/devices/0000:${GPU_ADDR}.0/iommu_group 2>/dev/null | xargs basename || echo "unknown"
      args:
        executable: /bin/bash
      register: gpu_iommu_temp
      changed_when: false
      failed_when: false
      when: has_gpu | default(false)
      tags: [gpu, terraform, mapping]

    - name: Find GPU IOMMU group number
      ansible.builtin.shell: |
        set -o pipefail
        for iommu_group in /sys/kernel/iommu_groups/*/devices/*; do
          if [[ "$iommu_group" == *"{{ gpu_pci.stdout.split('\n')[0] }}"* ]]; then
            echo "$iommu_group" | grep -oP 'iommu_groups/\K[0-9]+'
            break
          fi
        done
      args:
        executable: /bin/bash
      register: gpu_iommu_group
      changed_when: false
      when: has_gpu | default(false)
      tags: [gpu, terraform, mapping]

    - name: Create GPU resource mapping config file
      ansible.builtin.copy:
        dest: /etc/pve/mapping/pci.cfg
        content: |
          nvidia-gpu
          	map id={{ gpu_vendor_device.stdout }},iommugroup={{ gpu_iommu_group.stdout }},node={{ ansible_hostname }},path=0000:{{ gpu_pci.stdout.split('\n')[0].split('.')[0] }},subsystem-id={{ gpu_subsystem_id.stdout | default(gpu_vendor_device.stdout) }}
        mode: '0640'
      when:
        - has_gpu | default(false)
        - gpu_pci.rc == 0
        - gpu_vendor_device.rc == 0
        - gpu_iommu_group.stdout | length > 0
        - "'nvidia-gpu' not in (pci_mappings.stdout | default(''))"
      register: gpu_mapping_created
      tags: [gpu, terraform, mapping]

    - name: Grant Mapping.Use permission to terraform user
      ansible.builtin.command: >
        pveum acl modify /mapping/pci/nvidia-gpu -user terraform@pve -role PVEVMAdmin
      when: has_gpu | default(false)
      changed_when: false
      tags: [gpu, terraform, mapping]

    - name: Display GPU mapping status
      ansible.builtin.debug:
        msg: |
          GPU Resource Mapping: {{ 'Created' if gpu_mapping_created.changed | default(false) else 'Already exists or skipped' }}
          Terraform permission granted for /mapping/pci/nvidia-gpu
      when: has_gpu | default(false)
      tags: [gpu, terraform, mapping]

    - name: List IOMMU groups
      ansible.builtin.shell: |
        set -o pipefail
        find /sys/kernel/iommu_groups/ -type l | sort -V
      args:
        executable: /bin/bash
      register: iommu_groups
      changed_when: false
      failed_when: false
      tags: [iommu, gpu, info]

    - name: Display IOMMU group count
      ansible.builtin.debug:
        msg: "IOMMU groups found: {{ iommu_groups.stdout_lines | length if iommu_groups.rc == 0 else '0 (IOMMU not enabled or requires reboot)' }}"
      tags: [iommu, gpu, info]

    - name: Display post-configuration summary
      ansible.builtin.debug:
        msg: |
          ============================================================
          Proxmox Host Preparation Complete
          ============================================================

          System Information:
          - Host: {{ ansible_hostname }}
          - Proxmox Version: {{ pve_version.stdout }} ({{ proxmox_major_version }}.x)
          - CPU Vendor: {{ detected_cpu_vendor }}
          - Memory: {{ ansible_memtotal_mb }}MB

          Repository Configuration:
          - Enterprise repo disabled: {{ proxmox_disable_enterprise_repo }}
          - No-subscription repo enabled: {{ proxmox_enable_no_subscription_repo }}
          - Subscription nag removed: {{ proxmox_remove_subscription_nag }}
          - Ceph repo enabled: {{ proxmox_enable_ceph_repo }}

          System Updates:
          - System updated: {{ proxmox_update_system }}
          - Essential packages installed: {{ proxmox_install_essential_packages }}

          HA Services:
          - HA services disabled: {{ proxmox_disable_ha_services }}

          Security:
          - Firewall configured: {{ proxmox_configure_firewall }}
          - NTP configured: {{ proxmox_configure_ntp }}

          IOMMU Configuration:
          - Target GRUB cmdline: {{ target_grub_cmdline }}
          - GRUB updated: {{ grub_updated.changed }}
          - VFIO modules configured: {{ has_gpu | default(false) }}

          GPU Configuration:
          - GPU passthrough enabled: {{ has_gpu | default(false) }}
          {% if has_gpu | default(false) and gpu_info.rc == 0 %}
          - GPU detected: {{ gpu_info.stdout }}
          - PCI ID: {{ gpu_pci.stdout.split('.')[0] }}
          {% endif %}

          ZFS Configuration:
          - ZFS installed: {{ zfs_check.rc == 0 }}
          {% if zfs_check.rc == 0 %}
          - ARC max: {{ zfs_arc_max_gb | default(16) }}GB
          {% endif %}

          Network:
          - Bridge vmbr0: {{ 'Present' if bridge_check.rc == 0 else 'Not Found' }}

          ============================================================
          IMPORTANT: Reboot Required!
          ============================================================
          {% if grub_updated.changed or proxmox_remove_subscription_nag %}
          {% if grub_updated.changed %}
          GRUB configuration was updated. Reboot Proxmox host to apply changes:
          {% endif %}
          {% if proxmox_remove_subscription_nag %}
          Subscription nag was removed. Clear browser cache and reboot:
          {% endif %}

            ssh root@{{ ansible_host }} reboot

          After reboot:
          - Verify IOMMU is enabled: dmesg | grep -i iommu | grep -i enabled
          - Clear browser cache before accessing Proxmox web UI

          {% else %}
          No critical changes requiring reboot were made.
          {% endif %}

          Next Steps:
          1. Reboot Proxmox host (if required)
          2. Verify IOMMU is enabled (if using GPU passthrough)
          3. Clear browser cache (if subscription nag was removed)
          4. Build VM templates with Packer (cd packer/<os> && packer build .)
          5. Deploy VMs with Terraform (cd terraform && terraform apply)

          ============================================================
      tags: [always]

  handlers:
    - name: Update GRUB
      ansible.builtin.command: update-grub
      listen: Update GRUB

    - name: Update initramfs
      ansible.builtin.command: update-initramfs -u
      listen: Update initramfs

    - name: Restart pveproxy
      ansible.builtin.systemd:
        name: pveproxy
        state: restarted
      listen: Restart pveproxy
