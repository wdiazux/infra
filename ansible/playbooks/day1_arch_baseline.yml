# Day 1: Arch Linux VM Baseline Configuration
#
# This playbook configures newly deployed Arch Linux VMs with instance-specific settings.
# Baseline packages are pre-installed in the Packer golden image.
#
# Run with: ansible-playbook playbooks/day1-arch-baseline.yml
#
# Prerequisites:
# - Arch Linux VM deployed from Packer golden image (with baseline packages)
# - SSH access configured via cloud-init
# - User has sudo privileges
#
# Architecture (3-Layer):
# - Layer 1 (Packer): Baseline packages installed in golden image
# - Layer 2 (Terraform): Deploy VMs from golden image
# - Layer 3 (Ansible): Instance-specific configuration ONLY

---
- name: Configure Arch Linux VM Baseline
  hosts: arch_vms
  gather_facts: true
  become: true

  vars:
    # Timezone configuration
    timezone: "America/El_Salvador"

    # Locale configuration
    locale: "en_US.UTF-8"

    # Note: Baseline packages are pre-installed in Packer golden image:
    # - vim, git, htop, curl, wget, tmux, tree, net-tools, bind (dnsutils)
    # - python3, python3-pip, rsync, zip, unzip
    # - Security: ufw, crowdsec
    #
    # Only install instance-specific packages here (e.g., nfs-utils for NFS mounts)

    # AUR helper (optional)
    install_yay: false

    # Optional: Docker installation
    install_docker: false

    # Optional: Podman installation
    install_podman: false

    # Firewall allowed ports
    firewall_allowed_ports:
      - 22   # SSH

    # Optional: NFS mount configuration
    nfs_mounts: []

  tasks:
    - name: Display system information
      ansible.builtin.debug:
        msg: |
          Hostname: {{ ansible_hostname }}
          Distribution: {{ ansible_distribution }}
          Kernel: {{ ansible_kernel }}
          Architecture: {{ ansible_architecture }}
          CPU Cores: {{ ansible_processor_vcpus }}
          Memory: {{ ansible_memtotal_mb }}MB

    - name: Update package database
      community.general.pacman:
        update_cache: true

    - name: Upgrade all packages
      community.general.pacman:
        upgrade: true
      register: upgrade_result

    - name: Display upgrade summary
      ansible.builtin.debug:
        msg: "System upgrade: {{ 'completed' if upgrade_result.changed else 'no updates available' }}"

    - name: Install NFS client (if NFS mounts configured)
      community.general.pacman:
        name: nfs-utils
        state: present
      when: nfs_mounts | length > 0

    - name: Set timezone
      community.general.timezone:
        name: "{{ timezone }}"

    - name: Generate locale
      community.general.locale_gen:
        name: "{{ locale }}"
        state: present

    - name: Set default locale
      ansible.builtin.copy:
        dest: /etc/locale.conf
        content: |
          LANG={{ locale }}
        mode: '0644'

    - name: Set hostname
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"
      when: ansible_hostname != inventory_hostname

    - name: Update /etc/hosts
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1 {{ inventory_hostname }} {{ inventory_hostname.split('.')[0] }}"
        backup: true

    - name: Configure SSH daemon
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: true
      loop:
        - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
        - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
        - { regexp: '^#?X11Forwarding', line: 'X11Forwarding no' }
        - { regexp: '^#?MaxAuthTries', line: 'MaxAuthTries 3' }
        - { regexp: '^#?ClientAliveInterval', line: 'ClientAliveInterval 300' }
        - { regexp: '^#?ClientAliveCountMax', line: 'ClientAliveCountMax 2' }
      notify: Restart SSH

    - name: Reset UFW to defaults
      community.general.ufw:
        state: reset
      when: ansible_facts.services['ufw.service'] is defined

    - name: Set UFW default policies
      community.general.ufw:
        direction: "{{ item.direction }}"
        policy: "{{ item.policy }}"
      loop:
        - { direction: 'incoming', policy: 'deny' }
        - { direction: 'outgoing', policy: 'allow' }
        - { direction: 'routed', policy: 'deny' }

    - name: Allow firewall ports
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop: "{{ firewall_allowed_ports }}"

    - name: Enable UFW
      community.general.ufw:
        state: enabled

    - name: Check UFW status
      ansible.builtin.command: ufw status verbose
      register: ufw_status
      changed_when: false

    - name: Display UFW status
      ansible.builtin.debug:
        var: ufw_status.stdout_lines

    - name: Check if CrowdSec is installed
      ansible.builtin.command: which cscli
      register: crowdsec_installed
      changed_when: false
      failed_when: false

    - name: Ensure CrowdSec collections are installed
      ansible.builtin.shell: |
        cscli hub update
        cscli collections install crowdsecurity/linux --force
        cscli collections install crowdsecurity/sshd --force
      when: crowdsec_installed.rc == 0
      changed_when: false
      failed_when: false

    - name: Enable and start CrowdSec services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - crowdsec
        - crowdsec-firewall-bouncer
      when: crowdsec_installed.rc == 0
      failed_when: false

    - name: Check if yay is installed
      ansible.builtin.command: which yay
      register: yay_check
      changed_when: false
      failed_when: false
      when: install_yay

    - name: Clone yay repository
      ansible.builtin.git:
        repo: https://aur.archlinux.org/yay.git
        dest: /tmp/yay
        version: HEAD
      become: false
      when: install_yay and yay_check.rc != 0

    - name: Build and install yay
      ansible.builtin.command:
        cmd: makepkg -si --noconfirm
        chdir: /tmp/yay
      become: false
      when: install_yay and yay_check.rc != 0

    - name: Remove yay build directory
      ansible.builtin.file:
        path: /tmp/yay
        state: absent
      when: install_yay and yay_check.rc != 0

    - name: Install Docker
      community.general.pacman:
        name:
          - docker
          - docker-compose
        state: present
      when: install_docker

    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: true
      when: install_docker

    - name: Enable and start Docker
      ansible.builtin.systemd:
        name: docker
        enabled: true
        state: started
      when: install_docker

    - name: Install Podman
      community.general.pacman:
        name:
          - podman
          - podman-compose
        state: present
      when: install_podman

    - name: Create NFS mount points
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        mode: '0755'
      loop: "{{ nfs_mounts }}"
      when: nfs_mounts | length > 0

    - name: Add NFS mounts to /etc/fstab
      ansible.posix.mount:
        src: "{{ item.src }}"
        path: "{{ item.path }}"
        fstype: nfs
        opts: "{{ item.opts | default('defaults') }}"
        state: mounted
      loop: "{{ nfs_mounts }}"
      when: nfs_mounts | length > 0

    - name: Configure sysctl parameters
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: true
      loop:
        - { name: 'vm.swappiness', value: '10' }
        - { name: 'net.ipv4.tcp_keepalive_time', value: '600' }
        - { name: 'net.core.somaxconn', value: '1024' }

    - name: Enable color output in pacman
      ansible.builtin.lineinfile:
        path: /etc/pacman.conf
        regexp: '^#?Color'
        line: 'Color'

    - name: Enable parallel downloads in pacman
      ansible.builtin.lineinfile:
        path: /etc/pacman.conf
        regexp: '^#?ParallelDownloads'
        line: 'ParallelDownloads = 5'

    - name: Clean pacman cache
      ansible.builtin.command: pacman -Sc --noconfirm
      changed_when: false

    - name: Display configuration summary
      ansible.builtin.debug:
        msg: |
          ============================================================
          Arch Linux VM Baseline Configuration Complete
          ============================================================

          System:
          - Hostname: {{ inventory_hostname }}
          - Timezone: {{ timezone }}
          - Locale: {{ locale }}

          Security:
          - UFW firewall: Enabled
          - CrowdSec: Enabled
          - SSH hardening: Applied

          Packages:
          - Baseline packages: Installed
          - Security packages: Installed
          - Yay AUR helper: {{ 'Installed' if install_yay else 'Not installed' }}
          - Docker: {{ 'Installed' if install_docker else 'Not installed' }}
          - Podman: {{ 'Installed' if install_podman else 'Not installed' }}

          Network:
          - NFS mounts: {{ nfs_mounts | length }} configured

          ============================================================
          Next Steps:
          ============================================================
          1. Verify SSH access with key authentication
          2. Test firewall rules
          3. Configure application-specific settings
          4. Install AUR packages with yay (if installed)
          5. Set up monitoring and backups

          Note: Arch Linux is rolling release - regular updates required!
          Run: sudo pacman -Syu

          ============================================================

  handlers:
    - name: Restart SSH
      ansible.builtin.systemd:
        name: sshd
        state: restarted
