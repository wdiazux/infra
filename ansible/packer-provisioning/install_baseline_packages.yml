---
# Ansible Playbook for Packer Provisioning
# Install baseline packages during golden image creation
#
# This playbook is run during Packer builds to install packages into golden images.
# Post-deployment instance-specific configuration is handled by the baseline role.
#
# Architecture: Modular task files per OS for better maintainability

- name: Install Baseline Packages (Packer Provisioning)
  hosts: default
  become: yes
  gather_facts: yes

  vars:
    # Common packages to install (OS-specific names will be mapped)
    common_packages:
      - vim
      - git
      - htop
      - curl
      - wget
      - tmux
      - rsync
      - zip
      - unzip
      - tree
      - python3
      - python3-pip

    # SSH configuration (can be overridden from SOPS or Packer variables)
    # ssh_public_key: defined externally or empty
    # packer_ssh_user: defined externally (debian, ubuntu, root, etc.)

  tasks:
    # ==========================================================================
    # Display Build Information
    # ==========================================================================

    - name: Display Packer build information
      ansible.builtin.debug:
        msg: |
          ============================================================
          Packer Provisioning - Baseline Package Installation
          ============================================================
          Builder: {{ packer_builder_type | default('unknown') }}
          Build Name: {{ packer_build_name | default('unknown') }}
          OS Family: {{ ansible_facts['os_family'] }}
          Distribution: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}
          Architecture: {{ ansible_facts['architecture'] }}
          ============================================================
      tags: [always]

    # ==========================================================================
    # Include OS-Specific Package Installation Tasks
    # ==========================================================================

    - name: Include Debian/Ubuntu package installation tasks
      ansible.builtin.include_tasks: tasks/debian_packages.yml
      when: ansible_facts['os_family'] == "Debian"
      tags: [debian, ubuntu]

    - name: Include Arch Linux package installation tasks
      ansible.builtin.include_tasks: tasks/archlinux_packages.yml
      when: ansible_facts['os_family'] == "Archlinux"
      tags: [arch]

    # Note: Windows uses PowerShell provisioners in Packer, not Ansible
    # See packer/windows/scripts/ for Windows provisioning

    # ==========================================================================
    # SSH Key Configuration
    # ==========================================================================

    - name: Include SSH key configuration tasks
      ansible.builtin.include_tasks: tasks/ssh_keys.yml
      tags: [ssh]

    # ==========================================================================
    # Template Cleanup
    # ==========================================================================

    - name: Include cleanup tasks
      ansible.builtin.include_tasks: tasks/cleanup.yml
      tags: [cleanup]

    # ==========================================================================
    # Post-Installation Summary
    # ==========================================================================

    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          ============================================================
          Baseline Package Installation Complete
          ============================================================
          OS: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}
          Packages installed: {{ common_packages | length }}
          SSH key configured: {{ 'Yes' if ssh_public_key is defined and ssh_public_key != '' else 'No' }}
          Template cleanup: Complete
          Golden image ready for cloning
          ============================================================
      tags: [always]
