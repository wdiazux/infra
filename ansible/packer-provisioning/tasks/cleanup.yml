---
# Cleanup Tasks for Packer Provisioning
# This file handles template cleanup before conversion
#
# These tasks ensure the template is properly cleaned for cloning

- name: Display cleanup information
  ansible.builtin.debug:
    msg: |
      ============================================================
      Template Cleanup
      ============================================================
      OS Family: {{ ansible_facts['os_family'] }}
      Distribution: {{ ansible_facts['distribution'] }}
      Cleaning temporary files and preparing for template conversion
      ============================================================
  tags: [cleanup]

# =============================================================================
# Debian/Ubuntu Cleanup
# =============================================================================

- name: Remove unnecessary packages (Debian/Ubuntu)
  ansible.builtin.apt:
    autoremove: yes
    autoclean: yes
  when: ansible_facts['os_family'] == "Debian"
  tags: [cleanup, debian, ubuntu]

- name: Clean APT cache (Debian/Ubuntu)
  ansible.builtin.shell: |
    rm -f /var/cache/apt/archives/*.deb
    rm -f /var/cache/apt/*.bin
  when: ansible_facts['os_family'] == "Debian"
  changed_when: false
  tags: [cleanup, debian, ubuntu]

# =============================================================================
# CrowdSec Cleanup (Golden Image - Remove Instance-Specific Data)
# =============================================================================

- name: Clean CrowdSec credentials for golden image
  ansible.builtin.shell: |
    # Remove CAPI credentials (each VM should register independently)
    rm -f /etc/crowdsec/online_api_credentials.yaml 2>/dev/null || true
    # Remove LAPI credentials (regenerated on first boot)
    rm -f /etc/crowdsec/local_api_credentials.yaml 2>/dev/null || true
    # Remove machine registrations
    rm -f /etc/crowdsec/machines/*.yaml 2>/dev/null || true
    # Remove bouncer API keys
    rm -f /etc/crowdsec/bouncers/*.yaml 2>/dev/null || true
    # Clear database (contains machine-specific data)
    rm -f /var/lib/crowdsec/data/*.db 2>/dev/null || true
    # Remove first-boot marker so it runs on cloned VMs
    rm -f /var/lib/crowdsec/.first-boot-done 2>/dev/null || true
  changed_when: false
  failed_when: false
  tags: [cleanup, security]

# =============================================================================
# Arch Linux Cleanup
# =============================================================================

- name: Clean Pacman cache (Arch)
  ansible.builtin.command: pacman -Scc --noconfirm
  register: pacman_clean
  when: ansible_facts['os_family'] == "Archlinux"
  changed_when: "'Database directory cleaned up' in pacman_clean.stdout or 'Cache directory cleaned' in pacman_clean.stdout"
  failed_when: pacman_clean.rc not in [0, 1]
  tags: [cleanup, arch]

# =============================================================================
# Common Cleanup (All Distributions)
# =============================================================================

- name: Remove temporary files (excluding ansible)
  ansible.builtin.shell: |
    find /tmp -mindepth 1 -maxdepth 1 ! -name 'ansible*' -exec rm -rf {} + 2>/dev/null || true
    rm -rf /var/tmp/* 2>/dev/null || true
  changed_when: false
  tags: [cleanup]

- name: Clean cloud-init data
  ansible.builtin.shell: |
    cloud-init clean --logs --seed 2>/dev/null || \
    rm -rf /var/lib/cloud/{instance,instances,data,sem}/* 2>/dev/null || true
  changed_when: false
  failed_when: false
  tags: [cleanup]

- name: Reset machine-id for proper cloning
  ansible.builtin.shell: truncate -s 0 /etc/machine-id
  changed_when: false
  tags: [cleanup]

- name: Remove dbus machine-id
  ansible.builtin.file:
    path: /var/lib/dbus/machine-id
    state: absent
  tags: [cleanup]

- name: Create symlink for dbus machine-id
  ansible.builtin.file:
    src: /etc/machine-id
    dest: /var/lib/dbus/machine-id
    state: link
  tags: [cleanup]

- name: Sync filesystem
  ansible.builtin.command: sync
  changed_when: false
  tags: [cleanup]

- name: Display cleanup completion
  ansible.builtin.debug:
    msg: "âœ… Template cleanup completed successfully"
  tags: [cleanup]
