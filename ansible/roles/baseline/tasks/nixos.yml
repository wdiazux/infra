---
# NixOS-Specific Tasks
# These tasks handle instance-specific configuration AFTER VM deployment
# Packages should be pre-configured in Packer golden image's configuration.nix
#
# NixOS uses declarative configuration - we update configuration.nix and rebuild

# ==============================================================================
# Backup Current Configuration
# ==============================================================================

- name: Create backup of current NixOS configuration
  ansible.builtin.copy:
    src: /etc/nixos/configuration.nix
    dest: "/etc/nixos/configuration.nix.backup-{{ ansible_date_time.iso8601_basic_short }}"
    remote_src: yes
    mode: '0644'
  tags: [backup]

# ==============================================================================
# Instance-Specific Configuration
# ==============================================================================

- name: Set timezone in configuration.nix
  ansible.builtin.lineinfile:
    path: /etc/nixos/configuration.nix
    regexp: '^\s*time\.timeZone\s*='
    line: '  time.timeZone = "{{ baseline_timezone }}";'
    backup: yes
  register: nixos_config_changed
  tags: [config]

- name: Set locale in configuration.nix
  ansible.builtin.lineinfile:
    path: /etc/nixos/configuration.nix
    regexp: '^\s*i18n\.defaultLocale\s*='
    line: '  i18n.defaultLocale = "{{ baseline_locale }}";'
    backup: yes
  register: nixos_config_changed
  tags: [config]

# ==============================================================================
# SSH Hardening
# ==============================================================================

- name: Configure SSH settings in configuration.nix
  ansible.builtin.blockinfile:
    path: /etc/nixos/configuration.nix
    marker: "  # {mark} ANSIBLE MANAGED SSH CONFIGURATION"
    insertafter: "services.openssh"
    block: |
      services.openssh = {
        enable = true;
        settings = {
          PermitRootLogin = "{{ 'yes' if baseline_ssh_permit_root_login else 'no' }}";
          PasswordAuthentication = {{ 'true' if baseline_ssh_password_authentication else 'false' }};
          PubkeyAuthentication = {{ 'true' if baseline_ssh_pubkey_authentication else 'true' }};
        };
        ports = [ {{ baseline_ssh_port }} ];
      };
    backup: yes
  register: nixos_config_changed
  tags: [security, ssh]

# ==============================================================================
# Firewall Configuration
# ==============================================================================

- name: Configure firewall in configuration.nix
  ansible.builtin.blockinfile:
    path: /etc/nixos/configuration.nix
    marker: "  # {mark} ANSIBLE MANAGED FIREWALL CONFIGURATION"
    insertafter: "networking.firewall"
    block: |
      networking.firewall = {
        enable = {{ 'true' if baseline_firewall_enabled else 'false' }};
        allowedTCPPorts = [ {{ baseline_firewall_allowed_ports | join(' ') }} ];
      };
    backup: yes
  register: nixos_config_changed
  tags: [security, firewall]

# ==============================================================================
# NFS Mounts
# ==============================================================================

- name: Configure NFS mounts in configuration.nix
  ansible.builtin.blockinfile:
    path: /etc/nixos/configuration.nix
    marker: "  # {mark} ANSIBLE MANAGED NFS MOUNTS"
    insertafter: "fileSystems"
    block: |
      {% for mount in baseline_nfs_mounts %}
      fileSystems."{{ mount.path }}" = {
        device = "{{ mount.src }}";
        fsType = "nfs";
        options = [ "{{ mount.opts | default('defaults') }}" ];
      };
      {% endfor %}
    backup: yes
  when: baseline_nfs_mounts | length > 0
  register: nixos_config_changed
  tags: [storage, nfs]

# ==============================================================================
# System Performance Tuning
# ==============================================================================

- name: Configure sysctl parameters in configuration.nix
  ansible.builtin.blockinfile:
    path: /etc/nixos/configuration.nix
    marker: "  # {mark} ANSIBLE MANAGED SYSCTL PARAMETERS"
    insertafter: "boot.kernel.sysctl"
    block: |
      boot.kernel.sysctl = {
        "vm.swappiness" = {{ baseline_vm_swappiness }};
      {% for key, value in baseline_sysctl_params.items() %}
        "{{ key }}" = {{ value }};
      {% endfor %}
      };
    backup: yes
  register: nixos_config_changed
  tags: [performance, sysctl]

# ==============================================================================
# Apply NixOS Configuration
# ==============================================================================

- name: Apply NixOS configuration
  ansible.builtin.command: nixos-rebuild switch
  when: nixos_config_changed.changed
  async: 600  # 10 minutes timeout
  poll: 10
  register: nixos_rebuild
  tags: [apply]

- name: Display NixOS rebuild output
  ansible.builtin.debug:
    var: nixos_rebuild.stdout_lines
  when: nixos_config_changed.changed
  tags: [apply]

# ==============================================================================
# Display Configuration Summary
# ==============================================================================

- name: Display NixOS configuration summary
  ansible.builtin.debug:
    msg: |
      ============================================================
      NixOS Configuration Complete
      ============================================================
      Configuration file: /etc/nixos/configuration.nix
      Backup created: configuration.nix.backup-*
      Rebuild status: {{ 'Applied' if nixos_config_changed.changed else 'No changes' }}

      To make manual changes:
      1. Edit /etc/nixos/configuration.nix
      2. Test: sudo nixos-rebuild test
      3. Apply: sudo nixos-rebuild switch
      4. Rollback if needed: sudo nixos-rebuild --rollback switch
      ============================================================
  tags: [always]
