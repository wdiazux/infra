---
# Debian/Ubuntu-Specific Tasks
# These tasks handle instance-specific configuration AFTER VM deployment
# Packages should be pre-installed in Packer golden images

# ==============================================================================
# System Updates (Post-Deployment)
# ==============================================================================

- name: Update APT cache
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600
  tags: [updates]

- name: Upgrade all packages (post-deployment)
  ansible.builtin.apt:
    upgrade: dist
    autoremove: yes
    autoclean: yes
  when: baseline_auto_security_updates | bool
  tags: [updates]

# ==============================================================================
# Instance-Specific Configuration
# ==============================================================================

- name: Set timezone
  community.general.timezone:
    name: "{{ baseline_timezone }}"
  tags: [config]

- name: Generate locale
  community.general.locale_gen:
    name: "{{ baseline_locale }}"
    state: present
  tags: [config]

- name: Set default locale
  ansible.builtin.lineinfile:
    path: /etc/default/locale
    regexp: '^LANG='
    line: 'LANG={{ baseline_locale }}'
    create: yes
  tags: [config]

# ==============================================================================
# SSH Hardening
# ==============================================================================

- name: Configure SSH daemon
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    backup: yes
    validate: 'sshd -t -f %s'
  loop:
    - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin {{ "yes" if baseline_ssh_permit_root_login else "no" }}' }
    - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication {{ "yes" if baseline_ssh_password_authentication else "no" }}' }
    - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication {{ "yes" if baseline_ssh_pubkey_authentication else "no" }}' }
    - { regexp: '^#?Port', line: 'Port {{ baseline_ssh_port }}' }
  notify: restart ssh
  tags: [security, ssh]

# ==============================================================================
# Firewall Configuration
# ==============================================================================

- name: Enable UFW
  community.general.ufw:
    state: enabled
    policy: "{{ baseline_firewall_default_policy }}"
  when: baseline_firewall_enabled | bool
  tags: [security, firewall]

- name: Configure UFW allowed ports
  community.general.ufw:
    rule: allow
    port: "{{ item | string }}"
    proto: tcp
  loop: "{{ baseline_firewall_allowed_ports }}"
  when: baseline_firewall_enabled | bool
  tags: [security, firewall]

# ==============================================================================
# CrowdSec Configuration
# ==============================================================================

- name: Enable and start CrowdSec
  ansible.builtin.service:
    name: crowdsec
    state: started
    enabled: yes
  when: baseline_crowdsec_enabled | bool
  tags: [security, crowdsec]

- name: Install CrowdSec collections
  ansible.builtin.command:
    cmd: "cscli collections install {{ item }}"
  loop: "{{ baseline_crowdsec_collections }}"
  when: baseline_crowdsec_enabled | bool
  register: crowdsec_collections
  changed_when: "'installed' in crowdsec_collections.stdout"
  failed_when: false
  tags: [security, crowdsec]

- name: Enable CrowdSec firewall bouncer
  ansible.builtin.service:
    name: crowdsec-firewall-bouncer
    state: started
    enabled: yes
  when: baseline_crowdsec_enabled | bool
  tags: [security, crowdsec]

# ==============================================================================
# NFS Mounts
# ==============================================================================

- name: Create NFS mount points
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    mode: '0755'
  loop: "{{ baseline_nfs_mounts }}"
  when: baseline_nfs_mounts | length > 0
  tags: [storage, nfs]

- name: Configure NFS mounts
  ansible.posix.mount:
    src: "{{ item.src }}"
    path: "{{ item.path }}"
    fstype: nfs
    opts: "{{ item.opts | default('defaults') }}"
    state: "{{ item.state | default('mounted') }}"
  loop: "{{ baseline_nfs_mounts }}"
  when: baseline_nfs_mounts | length > 0
  tags: [storage, nfs]

# ==============================================================================
# System Performance Tuning
# ==============================================================================

- name: Configure sysctl parameters
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop: "{{ baseline_sysctl_params | dict2items }}"
  tags: [performance, sysctl]

- name: Set vm.swappiness
  ansible.posix.sysctl:
    name: vm.swappiness
    value: "{{ baseline_vm_swappiness }}"
    state: present
    reload: yes
  tags: [performance, sysctl]

# ==============================================================================
# Optional: Docker Installation
# ==============================================================================

- name: Install Docker (if requested)
  ansible.builtin.apt:
    name:
      - docker.io
      - docker-compose
    state: present
  when: baseline_install_docker | bool
  tags: [docker]

- name: Start and enable Docker
  ansible.builtin.service:
    name: docker
    state: started
    enabled: yes
  when: baseline_install_docker | bool
  tags: [docker]

# ==============================================================================
# Optional: Podman Installation
# ==============================================================================

- name: Install Podman (if requested)
  ansible.builtin.apt:
    name:
      - podman
      - podman-compose
    state: present
  when: baseline_install_podman | bool
  tags: [podman]
