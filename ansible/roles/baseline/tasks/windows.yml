---
# Windows-Specific Tasks
# These tasks handle instance-specific configuration AFTER VM deployment
# Packages should be pre-installed in Packer golden images

# ==============================================================================
# System Updates (Post-Deployment)
# ==============================================================================

- name: Check for Windows updates
  ansible.windows.win_updates:
    category_names:
      - SecurityUpdates
      - CriticalUpdates
    state: searched
  when: baseline_auto_security_updates | bool
  register: available_updates
  tags: [updates]

- name: Install Windows updates
  ansible.windows.win_updates:
    category_names:
      - SecurityUpdates
      - CriticalUpdates
    reboot: yes
  when:
    - baseline_auto_security_updates | bool
    - available_updates.found_update_count > 0
  tags: [updates]

# ==============================================================================
# Instance-Specific Configuration
# ==============================================================================

- name: Set timezone
  community.windows.win_timezone:
    timezone: "{{ baseline_timezone }}"
  tags: [config]

- name: Set computer name
  ansible.windows.win_hostname:
    name: "{{ inventory_hostname | regex_replace('\\..*$', '') }}"
  register: hostname_changed
  tags: [config]

- name: Reboot if hostname changed
  ansible.windows.win_reboot:
    msg: "Rebooting to apply hostname change"
    pre_reboot_delay: 10
    post_reboot_delay: 30
  when: hostname_changed.changed
  tags: [config]

# ==============================================================================
# Windows Firewall Configuration
# ==============================================================================

- name: Enable Windows Firewall for all profiles
  community.windows.win_firewall:
    state: enabled
    profiles:
      - Domain
      - Private
      - Public
  when: baseline_firewall_enabled | bool
  tags: [security, firewall]

- name: Configure firewall rules for allowed ports
  community.windows.win_firewall_rule:
    name: "Allow inbound on port {{ item }}"
    localport: "{{ item }}"
    action: allow
    direction: in
    protocol: tcp
    state: present
    enabled: yes
  loop: "{{ baseline_firewall_allowed_ports }}"
  when: baseline_firewall_enabled | bool
  tags: [security, firewall]

# ==============================================================================
# Windows Defender Configuration
# ==============================================================================

- name: Enable Windows Defender real-time protection
  ansible.windows.win_shell: |
    Set-MpPreference -DisableRealtimeMonitoring $false
  when: baseline_windows_defender_enabled | default(true) | bool
  tags: [security, defender]

- name: Configure Windows Defender exclusions
  ansible.windows.win_shell: |
    {% for exclusion in baseline_windows_defender_exclusions | default([]) %}
    Add-MpPreference -ExclusionPath "{{ exclusion }}"
    {% endfor %}
  when:
    - baseline_windows_defender_enabled | default(true) | bool
    - baseline_windows_defender_exclusions | default([]) | length > 0
  tags: [security, defender]

# ==============================================================================
# SMB/CIFS Shares (Windows equivalent of NFS mounts)
# ==============================================================================

- name: Map network drives
  ansible.windows.win_mapped_drive:
    letter: "{{ item.letter }}"
    path: "{{ item.path }}"
    state: present
    username: "{{ item.username | default(omit) }}"
    password: "{{ item.password | default(omit) }}"
  loop: "{{ baseline_smb_mounts | default([]) }}"
  when: baseline_smb_mounts | default([]) | length > 0
  tags: [storage, smb]

# ==============================================================================
# Windows Performance Tuning
# ==============================================================================

- name: Configure virtual memory (page file)
  ansible.windows.win_pagefile:
    drive: C
    initial_size: "{{ baseline_windows_pagefile_initial | default(2048) }}"
    maximum_size: "{{ baseline_windows_pagefile_maximum | default(4096) }}"
    state: present
  tags: [performance]

- name: Set power plan to High Performance
  ansible.windows.win_power_plan:
    name: high performance
  when: baseline_windows_high_performance | default(false) | bool
  tags: [performance]

# ==============================================================================
# Windows Features
# ==============================================================================

- name: Install .NET Framework 4.8
  ansible.windows.win_feature:
    name: NET-Framework-45-Core
    state: present
  when: baseline_windows_dotnet_enabled | default(true) | bool
  tags: [features]

- name: Install Telnet Client
  ansible.windows.win_feature:
    name: Telnet-Client
    state: present
  when: baseline_windows_telnet_enabled | default(false) | bool
  tags: [features]

# ==============================================================================
# Optional: Docker Installation (Windows Containers)
# ==============================================================================

- name: Install Docker (Windows Containers)
  ansible.windows.win_chocolatey:
    name: docker-desktop
    state: present
  when: baseline_install_docker | bool
  tags: [docker]

- name: Start Docker service
  ansible.windows.win_service:
    name: docker
    state: started
    start_mode: auto
  when: baseline_install_docker | bool
  tags: [docker]

# ==============================================================================
# Windows Registry Tweaks
# ==============================================================================

- name: Disable Windows telemetry
  ansible.windows.win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection
    name: AllowTelemetry
    data: 0
    type: dword
  when: baseline_windows_disable_telemetry | default(false) | bool
  tags: [privacy]

- name: Disable Windows Update automatic restart
  ansible.windows.win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU
    name: NoAutoRebootWithLoggedOnUsers
    data: 1
    type: dword
  when: baseline_windows_disable_auto_reboot | default(true) | bool
  tags: [updates]
