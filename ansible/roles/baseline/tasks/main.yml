---
# Baseline Role - Main Tasks
#
# This file loads OS-specific variables and includes OS-specific task files
# Best Practice: Use ansible_os_family and ansible_distribution for OS detection

# ==============================================================================
# Load OS-Specific Variables
# ==============================================================================

- name: Display system information
  ansible.builtin.debug:
    msg: |
      Hostname: {{ ansible_hostname }}
      OS Family: {{ ansible_os_family }}
      Distribution: {{ ansible_distribution }}
      Distribution Version: {{ ansible_distribution_version }}
      Architecture: {{ ansible_architecture }}
  tags: [always]

- name: Load OS-specific variables (Debian/Ubuntu)
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - files:
        - "{{ ansible_distribution }}.yml"
        - "{{ ansible_os_family }}.yml"
      paths:
        - "vars"
  when: ansible_os_family == "Debian"
  tags: [always]

- name: Load OS-specific variables (Arch Linux)
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - files:
        - "{{ ansible_distribution }}.yml"
        - "Archlinux.yml"
      paths:
        - "vars"
  when: ansible_os_family == "Archlinux"
  tags: [always]

- name: Load OS-specific variables (NixOS)
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - files:
        - "{{ ansible_distribution }}.yml"
        - "NixOS.yml"
      paths:
        - "vars"
  when: ansible_distribution == "NixOS"
  tags: [always]

- name: Load OS-specific variables (Windows)
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - files:
        - "{{ ansible_os_family }}.yml"
        - "Windows.yml"
      paths:
        - "vars"
  when: ansible_os_family == "Windows"
  tags: [always]

# ==============================================================================
# Map Common Package Names to OS-Specific Names
# ==============================================================================

- name: Map common packages to OS-specific package names
  ansible.builtin.set_fact:
    os_specific_packages: >-
      {{
        baseline_common_packages |
        map('extract', os_package_map) |
        select('defined') |
        list
      }}
  when: os_package_map is defined
  tags: [packages]

- name: Display package mapping
  ansible.builtin.debug:
    msg: |
      Common Packages: {{ baseline_common_packages }}
      OS-Specific Packages: {{ os_specific_packages | default([]) }}
  tags: [packages]

# ==============================================================================
# Include OS-Specific Tasks
# ==============================================================================

- name: Include Debian/Ubuntu tasks
  ansible.builtin.include_tasks: debian.yml
  when: ansible_os_family == "Debian"
  tags: [debian, ubuntu]

- name: Include Arch Linux tasks
  ansible.builtin.include_tasks: archlinux.yml
  when: ansible_os_family == "Archlinux"
  tags: [arch]

- name: Include NixOS tasks
  ansible.builtin.include_tasks: nixos.yml
  when: ansible_distribution == "NixOS"
  tags: [nixos]

- name: Include Windows tasks
  ansible.builtin.include_tasks: windows.yml
  when: ansible_os_family == "Windows"
  tags: [windows]

# ==============================================================================
# Common Post-Configuration Tasks (All OS)
# ==============================================================================

- name: Display baseline configuration complete message
  ansible.builtin.debug:
    msg: |
      ============================================================
      Baseline Configuration Complete
      ============================================================
      Hostname: {{ ansible_hostname }}
      OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
      Timezone: {{ baseline_timezone }}
      Packages Installed: {{ os_specific_packages | default([]) | length }}
      Docker: {{ 'Installed' if baseline_install_docker else 'Not installed' }}
      Podman: {{ 'Installed' if baseline_install_podman else 'Not installed' }}
      ============================================================
  tags: [always]
