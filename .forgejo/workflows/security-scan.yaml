# Security Scanning Workflow
#
# Runs Trivy security scans on:
# - Terraform configurations (misconfigurations)
# - Kubernetes manifests (CVEs, misconfigs)
# - Dockerfiles (best practices)
#
# Uses Docker containers directly since runner doesn't have sudo
name: Security Scan

on:
  push:
    branches: [main]
    paths:
      - 'terraform/**'
      - 'kubernetes/**'
      - 'docker/**'
      - 'packer/**'
      - '.forgejo/workflows/**'
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger

jobs:
  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    container:
      image: aquasec/trivy:latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan Terraform configs
        run: trivy config terraform/ --severity HIGH,CRITICAL --exit-code 0
        continue-on-error: true

      - name: Scan Kubernetes manifests
        run: trivy config kubernetes/ --severity HIGH,CRITICAL --exit-code 0
        continue-on-error: true

      - name: Scan Dockerfiles
        run: trivy config docker/ --severity HIGH,CRITICAL --exit-code 0
        continue-on-error: true

      - name: Secret detection
        run: trivy fs . --scanners secret --severity HIGH,CRITICAL --exit-code 0 --skip-dirs .git,secrets
        continue-on-error: true

  terraform-lint:
    name: Terraform Lint
    runs-on: ubuntu-latest
    container:
      image: hashicorp/terraform:1.10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Terraform Format Check
        run: terraform fmt -check -recursive terraform/
        continue-on-error: true

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    container:
      image: cytopia/yamllint:latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run yamllint
        run: yamllint -c .yamllint.yaml kubernetes/
        continue-on-error: true
