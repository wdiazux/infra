# Security Scanning Workflow
#
# Runs Trivy security scans on:
# - Terraform configurations (misconfigurations)
# - Kubernetes manifests (CVEs, misconfigs)
# - Dockerfiles (best practices)
#
# Uses docker run to execute tools since runner is minimal
# Images are pulled once per job for efficiency
name: Security Scan

on:
  push:
    branches: [main]
    paths:
      - 'terraform/**'
      - 'kubernetes/**'
      - 'docker/**'
      - 'packer/**'
      - '.forgejo/workflows/**'
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger

env:
  # Pin versions for reproducibility and better caching
  TRIVY_VERSION: "0.58.0"
  TERRAFORM_VERSION: "1.10"
  YAMLLINT_VERSION: "1.35"

jobs:
  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Pull Trivy image
        run: docker pull aquasec/trivy:${{ env.TRIVY_VERSION }}

      - name: Run all security scans
        run: |
          echo "=== Scanning Terraform configs ==="
          docker run --rm -v $PWD:/work aquasec/trivy:${{ env.TRIVY_VERSION }} config /work/terraform/ --severity HIGH,CRITICAL --exit-code 0 || true

          echo ""
          echo "=== Scanning Kubernetes manifests ==="
          docker run --rm -v $PWD:/work aquasec/trivy:${{ env.TRIVY_VERSION }} config /work/kubernetes/ --severity HIGH,CRITICAL --exit-code 0 || true

          echo ""
          echo "=== Scanning Dockerfiles ==="
          docker run --rm -v $PWD:/work aquasec/trivy:${{ env.TRIVY_VERSION }} config /work/docker/ --severity HIGH,CRITICAL --exit-code 0 || true

          echo ""
          echo "=== Secret detection ==="
          docker run --rm -v $PWD:/work aquasec/trivy:${{ env.TRIVY_VERSION }} fs /work --scanners secret --severity HIGH,CRITICAL --exit-code 0 --skip-dirs .git,secrets || true

          echo ""
          echo "=== Security scan complete ==="

  terraform-lint:
    name: Terraform Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Terraform Format Check
        run: |
          docker run --rm -v $PWD:/work -w /work hashicorp/terraform:${{ env.TERRAFORM_VERSION }} fmt -check -recursive terraform/
        continue-on-error: true

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run yamllint
        run: |
          docker run --rm -v $PWD:/work cytopia/yamllint:${{ env.YAMLLINT_VERSION }} -c /work/.yamllint.yaml /work/kubernetes/
        continue-on-error: true
