# Security Scanning Workflow
#
# Runs Trivy security scans on:
# - Terraform configurations (misconfigurations)
# - Kubernetes manifests (CVEs, misconfigs)
# - Dockerfiles (best practices)
#
# Uses docker run to execute tools since runner is minimal
name: Security Scan

on:
  push:
    branches: [main]
    paths:
      - 'terraform/**'
      - 'kubernetes/**'
      - 'docker/**'
      - 'packer/**'
      - '.forgejo/workflows/**'
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger

jobs:
  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan Terraform configs
        run: |
          docker run --rm -v $PWD:/work aquasec/trivy:latest config /work/terraform/ --severity HIGH,CRITICAL --exit-code 0
        continue-on-error: true

      - name: Scan Kubernetes manifests
        run: |
          docker run --rm -v $PWD:/work aquasec/trivy:latest config /work/kubernetes/ --severity HIGH,CRITICAL --exit-code 0
        continue-on-error: true

      - name: Scan Dockerfiles
        run: |
          docker run --rm -v $PWD:/work aquasec/trivy:latest config /work/docker/ --severity HIGH,CRITICAL --exit-code 0
        continue-on-error: true

      - name: Secret detection
        run: |
          docker run --rm -v $PWD:/work aquasec/trivy:latest fs /work --scanners secret --severity HIGH,CRITICAL --exit-code 0 --skip-dirs .git,secrets
        continue-on-error: true

  terraform-lint:
    name: Terraform Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Terraform Format Check
        run: |
          docker run --rm -v $PWD:/work -w /work hashicorp/terraform:1.10 fmt -check -recursive terraform/
        continue-on-error: true

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run yamllint
        run: |
          docker run --rm -v $PWD:/work cytopia/yamllint:latest -c /work/.yamllint.yaml /work/kubernetes/
        continue-on-error: true
