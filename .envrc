use nix
watch_file shell.nix

# Claude Code settings
export CLAUDE_CODE_FILE_READ_MAX_OUTPUT_TOKENS=50000

# SOPS Age key location
export SOPS_AGE_KEY_FILE="$HOME/.config/sops/age/keys.txt"

alias kubectl="kubecolor"

# Set KUBECONFIG and TALOSCONFIG for this directory
# These point to the generated config files from Terraform
export KUBECONFIG="./terraform/talos/kubeconfig"
export TALOSCONFIG="./terraform/talos/talosconfig"

# Load Proxmox credentials from SOPS (if file exists)
SECRETS_FILE="./secrets/proxmox-creds.enc.yaml"
if [ -f "$SECRETS_FILE" ]; then
    export PROXMOX_URL=$(sops -d "$SECRETS_FILE" 2>/dev/null | yq '.proxmox_url' 2>/dev/null || echo "")
    PROXMOX_TOKEN_SECRET=$(sops -d "$SECRETS_FILE" 2>/dev/null | yq '.proxmox_token_secret' 2>/dev/null || echo "")
    export PROXMOX_NODE=$(sops -d "$SECRETS_FILE" 2>/dev/null | yq '.proxmox_node' 2>/dev/null || echo "")
    export PROXMOX_STORAGE_POOL=$(sops -d "$SECRETS_FILE" 2>/dev/null | yq '.proxmox_storage_pool' 2>/dev/null || echo "")

    # Get user and token ID from SOPS
    PROXMOX_USER=$(sops -d "$SECRETS_FILE" 2>/dev/null | yq '.proxmox_user' 2>/dev/null || echo "")
    PROXMOX_TOKEN_ID=$(sops -d "$SECRETS_FILE" 2>/dev/null | yq '.proxmox_token_id' 2>/dev/null || echo "")

    # Export for Packer (official format from Proxmox plugin docs)
    if [ -n "$PROXMOX_USER" ] && [ -n "$PROXMOX_TOKEN_ID" ] && [ -n "$PROXMOX_TOKEN_SECRET" ]; then
        # Username must be: user@realm!tokenid (per Packer Proxmox plugin docs)
        export PROXMOX_USERNAME="${PROXMOX_USER}!${PROXMOX_TOKEN_ID}"
        # Token is just the secret value
        export PROXMOX_TOKEN="$PROXMOX_TOKEN_SECRET"

        # For Terraform: full PVEAPIToken format
        export PROXMOX_API_TOKEN="PVEAPIToken=${PROXMOX_USER}!${PROXMOX_TOKEN_ID}=${PROXMOX_TOKEN_SECRET}"
    fi
fi

# Load Git credentials for FluxCD from SOPS (if file exists)
GIT_CREDS_FILE="./secrets/git-creds.enc.yaml"
if [ -f "$GIT_CREDS_FILE" ]; then
    # Export as TF_VAR_* for Terraform
    export TF_VAR_git_provider=$(sops -d "$GIT_CREDS_FILE" 2>/dev/null | yq '.git_provider' 2>/dev/null || echo "forgejo")
    export TF_VAR_git_hostname=$(sops -d "$GIT_CREDS_FILE" 2>/dev/null | yq '.git_hostname' 2>/dev/null || echo "")
    export TF_VAR_git_owner=$(sops -d "$GIT_CREDS_FILE" 2>/dev/null | yq '.git_owner' 2>/dev/null || echo "")
    export TF_VAR_git_repository=$(sops -d "$GIT_CREDS_FILE" 2>/dev/null | yq '.git_repository' 2>/dev/null || echo "infra")
    export TF_VAR_git_token=$(sops -d "$GIT_CREDS_FILE" 2>/dev/null | yq '.git_token' 2>/dev/null || echo "")

    # Also export GITEA_TOKEN for flux CLI manual use
    export GITEA_TOKEN="$TF_VAR_git_token"

    watch_file "$GIT_CREDS_FILE"
fi
